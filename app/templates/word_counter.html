<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä½œæ–‡å­—æ•°ç»Ÿè®¡ - è¶…èƒ½åŠ›è®­ç»ƒåœº</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .col-md-7, .col-md-5 {
                width: 100%;
                max-width: 100%;
                margin-bottom: 1rem;
            }
            
            #aiThinkingOutput {
                height: 150px !important;
                font-size: 0.8em !important;
            }
            
            .btn {
                margin-bottom: 0.5rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .card-body {
                padding: 1rem !important;
            }
        }
        
        /* AIæ€è€ƒè¾“å‡ºæ ·å¼ */
        #aiThinkingOutput {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        #aiThinkingOutput:hover {
            background-color: #e9ecef;
        }
        
        /* æŠ˜å æŒ‰é’®æ ·å¼ */
        .btn-link {
            border: none !important;
            box-shadow: none !important;
        }
        
        .btn-link:focus {
            box-shadow: none !important;
        }
        
        /* æ‰‹é£ç´æ ·å¼ */
        .accordion-button {
            padding: 0.75rem 1rem;
            font-weight: 500;
        }
        
        .accordion-button:not(.collapsed) {
            background-color: #e7f3ff;
            border-color: #b3d9ff;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        #aiThinkingOutput::-webkit-scrollbar {
            width: 8px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ­£åœ¨è¾“å…¥è¡Œçš„å…‰æ ‡æ•ˆæœ */
        .current-line::after {
            content: 'â–Š';
            color: #007bff;
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* AIæ€è€ƒè¿‡ç¨‹æ æ ·å¼ */
        #aiThinkingOutput {
            transition: height 0.2s ease;
        }
        
        #aiThinkingOutput::-webkit-scrollbar {
            width: 8px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* è°ƒèŠ‚é«˜åº¦çš„æç¤º */
        .resize-hint {
            position: absolute;
            bottom: 2px;
            right: 2px;
            color: #ccc;
            font-size: 12px;
            pointer-events: none;
        }
        
        /* ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– */
        @media (max-width: 576px) {
            .container {
                padding: 0 10px;
            }
            
            .btn {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
            
            #aiThinkingOutput {
                height: 120px !important;
                font-size: 0.75em !important;
            }
            
            .card-header h5, .card-header h6 {
                font-size: 1rem;
            }
            
            /* ä¿®å¤ç§»åŠ¨ç«¯AIæ‰¹æ”¹ç»“æœæ˜¾ç¤º */
            #correctionResults .accordion-button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            #correctionResults .accordion-body {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            #correctionResults .alert {
                padding: 0.5rem;
                margin-bottom: 0.75rem;
            }
            
            /* ç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šaccordionèƒ½æ­£å¸¸å·¥ä½œ */
            .accordion-collapse {
                transition: height 0.3s ease;
            }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="mb-4">ä½œæ–‡å­—æ•°ç»Ÿè®¡</h1>
        
        {% include '_navigation.html' %}

        <div class="row">
            <!-- æ–‡æœ¬è¾“å…¥å’ŒAIæ‰¹æ”¹ç»“æœåŒºåŸŸ -->
            <div class="col-md-7">
                <!-- ä½œæ–‡è¾“å…¥æ¡† -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-edit me-2"></i>è¾“å…¥æ‚¨çš„ä½œæ–‡
                        </h5>
                    </div>
                    <div class="card-body">
                        <textarea
                            id="essayText"
                            class="form-control"
                            rows="10"
                            placeholder="è¯·åœ¨æ­¤å¤„è¾“å…¥æ‚¨çš„ä½œæ–‡å†…å®¹..."
                            style="resize: vertical; min-height: 250px;"
                        ></textarea>
                        <!-- ä½œæ–‡è¦æ±‚é€‰æ‹©å™¨ -->
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="languageSelect" class="form-label small">
                                        <i class="fas fa-globe me-1"></i>è¯­è¨€
                                    </label>
                                    <select id="languageSelect" class="form-select form-select-sm">
                                        <option value="zh" selected>ä¸­æ–‡</option>
                                        <option value="en">English</option>
                                        <option value="es">EspaÃ±ol</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="wordCountSelect" class="form-label small">
                                        <i class="fas fa-ruler me-1"></i><span id="wordCountLabel">ä½œæ–‡å­—æ•°è¦æ±‚</span>
                                    </label>
                                    <select id="wordCountSelect" class="form-select form-select-sm">
                                        <!-- åŠ¨æ€å¡«å……é€‰é¡¹ -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="gradeSelect" class="form-label small">
                                        <i class="fas fa-graduation-cap me-1"></i>å¹´çº§
                                    </label>
                                    <select id="gradeSelect" class="form-select form-select-sm">
                                        <option value="ä¸€å¹´çº§">ä¸€å¹´çº§</option>
                                        <option value="äºŒå¹´çº§">äºŒå¹´çº§</option>
                                        <option value="ä¸‰å¹´çº§" selected>ä¸‰å¹´çº§</option>
                                        <option value="å››å¹´çº§">å››å¹´çº§</option>
                                        <option value="äº”å¹´çº§">äº”å¹´çº§</option>
                                        <option value="å…­å¹´çº§">å…­å¹´çº§</option>
                                        <option value="åˆä¸€">åˆä¸€</option>
                                        <option value="åˆäºŒ">åˆäºŒ</option>
                                        <option value="åˆä¸‰">åˆä¸‰</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button id="clearBtn" class="btn btn-outline-danger">
                                <i class="fas fa-trash me-1"></i>æ¸…ç©º
                            </button>
                            <button id="analyzeBtn" class="btn btn-primary ms-2">
                                <i class="fas fa-calculator me-1"></i>ç»Ÿè®¡å­—æ•°
                            </button>
                            <button id="correctBtn" class="btn btn-success ms-2">
                                <i class="fas fa-edit me-1"></i>AIæ‰¹æ”¹
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AIæ‰¹æ”¹ç»“æœåŒºåŸŸ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-robot me-2 text-success"></i>AIæ‰¹æ”¹ç»“æœ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="correctionResults">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                è¯·è¾“å…¥ä½œæ–‡åç‚¹å‡»"AIæ‰¹æ”¹"
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¿¡æ¯å’Œè°ƒè¯•åŒºåŸŸ -->
            <div class="col-md-5">
                <!-- ç»Ÿè®¡ç»“æœåŒºåŸŸ -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>ç»Ÿè®¡ç»“æœ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="statsResults">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                è¯·è¾“å…¥æ–‡æœ¬åç‚¹å‡»"ç»Ÿè®¡å­—æ•°"
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AIæ€è€ƒè¿‡ç¨‹é¢æ¿ -->
                <div id="aiThinkingPanel" class="card mt-3" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-brain me-2 text-info"></i>
                                <span id="aiThinkingTitle">AIæ­£åœ¨æ€è€ƒ...</span>
                            </h6>
                            <div>
                                <button id="clearThinkingBtn" class="btn btn-sm btn-outline-secondary me-2">
                                    <i class="fas fa-eraser"></i>
                                </button>
                                <a data-bs-toggle="collapse" href="#aiThinkingContent" role="button" aria-expanded="true" aria-controls="aiThinkingContent">
                                    <i id="aiThinkingChevron" class="fas fa-chevron-up text-secondary"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div id="aiThinkingContent" class="collapse show">
                        <div class="card-body p-0">
                            <div id="aiThinkingOutput" class="p-3">
                                <div class="text-muted">ç­‰å¾…AIå¼€å§‹æ‰¹æ”¹...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡è¯´æ˜ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-question-circle me-2"></i>åŠŸèƒ½è¯´æ˜
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled small text-muted">
                            <li><i class="fas fa-dot-circle me-2"></i>æ±‰å­—ï¼šä¸­æ–‡å­—ç¬¦æ•°é‡</li>
                            <li><i class="fas fa-dot-circle me-2"></i>æ ‡ç‚¹ï¼šä¸­è‹±æ–‡æ ‡ç‚¹ç¬¦å·</li>
                            <li><i class="fas fa-dot-circle me-2"></i>è‹±æ–‡å•è¯ï¼šè¿ç»­å­—æ¯ç»„æˆçš„å•è¯</li>
                            <li><i class="fas fa-dot-circle me-2"></i>æ€»å­—ç¬¦ï¼šåŒ…å«æ‰€æœ‰å­—ç¬¦</li>
                            <li><i class="fas fa-dot-circle me-2 text-success"></i>AIæ‰¹æ”¹ï¼šæ£€æŸ¥ç—…å¥ã€é”™åˆ«å­—ã€æ ‡ç‚¹ç­‰</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const essayText = document.getElementById('essayText');
        const clearBtn = document.getElementById('clearBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const correctBtn = document.getElementById('correctBtn');
        const statsResults = document.getElementById('statsResults');
        const correctionResults = document.getElementById('correctionResults');
        const aiThinkingPanel = document.getElementById('aiThinkingPanel');
        const aiThinkingOutput = document.getElementById('aiThinkingOutput');
        const aiThinkingTitle = document.getElementById('aiThinkingTitle');
        const aiThinkingChevron = document.getElementById('aiThinkingChevron');
        const clearThinkingBtn = document.getElementById('clearThinkingBtn');
        const wordCountSelect = document.getElementById('wordCountSelect');
        const gradeSelect = document.getElementById('gradeSelect');
        const languageSelect = document.getElementById('languageSelect');
        const wordCountLabel = document.getElementById('wordCountLabel');

        // è¯­è¨€å¯¹åº”çš„å­—æ•°é€‰é¡¹é…ç½®
        const wordCountOptions = {
            'zh': {
                label: 'ä½œæ–‡å­—æ•°è¦æ±‚',
                options: [
                    { value: 'ä¸é™å­—æ•°', text: 'ä¸é™å­—æ•°' },
                    { value: '300å­—å·¦å³', text: '300å­—å·¦å³' },
                    { value: '400å­—å·¦å³', text: '400å­—å·¦å³' },
                    { value: '500å­—å·¦å³', text: '500å­—å·¦å³' },
                    { value: '600å­—å·¦å³', text: '600å­—å·¦å³' },
                    { value: '700å­—å·¦å³', text: '700å­—å·¦å³' },
                    { value: '1000å­—å·¦å³', text: '1000å­—å·¦å³' },
                    { value: '1500å­—ä»¥ä¸Š', text: '1500å­—ä»¥ä¸Š' }
                ]
            },
            'en': {
                label: 'Word Count Requirement',
                options: [
                    { value: 'No limit', text: 'No limit' },
                    { value: '60 words', text: '60 words' },
                    { value: '80 words', text: '80 words' },
                    { value: '100 words', text: '100 words' },
                    { value: '150 words', text: '150 words' },
                    { value: '200 words', text: '200 words' },
                    { value: '300 words', text: '300 words' },
                    { value: '500 words', text: '500 words' },
                    { value: '1000 words', text: '1000 words' }
                ]
            },
            'es': {
                label: 'Requisito de Palabras',
                options: [
                    { value: 'Sin lÃ­mite', text: 'Sin lÃ­mite' },
                    { value: '60 palabras', text: '60 palabras' },
                    { value: '80 palabras', text: '80 palabras' },
                    { value: '100 palabras', text: '100 palabras' },
                    { value: '150 palabras', text: '150 palabras' },
                    { value: '200 palabras', text: '200 palabras' },
                    { value: '300 palabras', text: '300 palabras' },
                    { value: '500 palabras', text: '500 palabras' },
                    { value: '1000 palabras', text: '1000 palabras' }
                ]
            }
        };

        // æ›´æ–°å­—æ•°é€‰é¡¹
        function updateWordCountOptions(language) {
            const config = wordCountOptions[language];
            wordCountLabel.textContent = config.label;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            wordCountSelect.innerHTML = '';

            // æ·»åŠ æ–°é€‰é¡¹
            config.options.forEach((option, index) => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                if (index === 0) optionElement.selected = true; // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                wordCountSelect.appendChild(optionElement);
            });
        }

        // è¯­è¨€åˆ‡æ¢äº‹ä»¶ç›‘å¬
        languageSelect.addEventListener('change', function() {
            const selectedLanguage = this.value;
            updateWordCountOptions(selectedLanguage);

            // é‡æ–°åˆ†ææ–‡æœ¬ï¼ˆå¦‚æœæœ‰å†…å®¹çš„è¯ï¼‰
            const text = essayText.value.trim();
            if (text) {
                analyzeText(text, selectedLanguage);
            }
        });

        // åˆå§‹åŒ–å­—æ•°é€‰é¡¹ï¼ˆé»˜è®¤ä¸­æ–‡ï¼‰
        updateWordCountOptions('zh');

        // éªŒè¯å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
        console.log('DOM Elements verification:');
        console.log('essayText:', essayText);
        console.log('correctionResults:', correctionResults);
        console.log('aiThinkingOutput:', aiThinkingOutput);
        console.log('wordCountSelect:', wordCountSelect);
        console.log('gradeSelect:', gradeSelect);
        console.log('languageSelect:', languageSelect);
        
        // å¦‚æœå…³é”®å…ƒç´ ç¼ºå¤±ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (!correctionResults) {
            console.error('Critical: correctionResults element not found!');
            alert('é¡µé¢åŠ è½½å¼‚å¸¸ï¼ŒcorrectionResultså…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢');
        }
        
        if (!aiThinkingOutput) {
            console.error('Critical: aiThinkingOutput element not found!');
        }
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            if (e.error && e.error.message && e.error.message.includes('JSON')) {
                console.warn('JSON parsing error detected, this is handled gracefully');
            }
        });
        
        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬ï¼ˆé’ˆå¯¹ç§»åŠ¨ç«¯èƒŒæ™¯åˆ‡æ¢é—®é¢˜ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isMobileSafari()) {
                // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æ‰¹æ”¹ä»»åŠ¡
                console.log('Page became visible on mobile Safari');
            }
        });

        // æ¸…ç©ºæ–‡æœ¬
        clearBtn.addEventListener('click', function() {
            essayText.value = '';
            showInitialMessage();
            showInitialCorrectionMessage();
            hideAiThinkingPanel();
        });

        // æ¸…ç©ºAIæ€è€ƒè¾“å‡º
        clearThinkingBtn.addEventListener('click', function() {
            clearAiThinkingOutput();
        });

        // ç›‘å¬æŠ˜å çŠ¶æ€å˜åŒ–
        document.getElementById('aiThinkingContent').addEventListener('show.bs.collapse', function () {
            aiThinkingChevron.classList.remove('fa-chevron-down');
            aiThinkingChevron.classList.add('fa-chevron-up');
        });

        document.getElementById('aiThinkingContent').addEventListener('hide.bs.collapse', function () {
            aiThinkingChevron.classList.remove('fa-chevron-up');
            aiThinkingChevron.classList.add('fa-chevron-down');
        });

        // åˆ†ææ–‡æœ¬
        analyzeBtn.addEventListener('click', function() {
            const text = essayText.value.trim();
            if (!text) {
                alert('è¯·å…ˆè¾“å…¥æ–‡æœ¬å†…å®¹');
                return;
            }
            const language = languageSelect.value;
            analyzeText(text, language);
        });

        // AIæ‰¹æ”¹ä½œæ–‡
        correctBtn.addEventListener('click', function() {
            const text = essayText.value.trim();
            if (!text) {
                alert('è¯·å…ˆè¾“å…¥ä½œæ–‡å†…å®¹');
                return;
            }
            if (text.length < 50) {
                alert('ä½œæ–‡å†…å®¹è¿‡çŸ­ï¼Œè¯·è¾“å…¥è‡³å°‘50ä¸ªå­—ç¬¦çš„ä½œæ–‡');
                return;
            }
            const language = languageSelect.value;
            correctEssay(text, language);
        });

        // æ£€æµ‹è®¾å¤‡å’Œæµè§ˆå™¨ç±»å‹
        function isMobileSafari() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua) && !/CriOS/.test(ua) && !/FxiOS/.test(ua);
            const isIPadOS = /Macintosh/.test(ua) && 'ontouchend' in document; // iPadOS 13+ æ£€æµ‹
            
            console.log('Device detection - UA:', ua);
            console.log('Device detection - isIOS:', isIOS, 'isSafari:', isSafari, 'isIPadOS:', isIPadOS);
            
            return (isIOS || isIPadOS) && isSafari;
        }
        
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ï¼ˆåŒ…æ‹¬Androidï¼‰
        function isMobileDevice() {
            const ua = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            const isTablet = /iPad/.test(ua) || (/Macintosh/.test(ua) && 'ontouchend' in document);
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            return isMobile || isTablet || hasTouch;
        }

        // æ£€æµ‹æ˜¯å¦æ”¯æŒæµå¼å¤„ç†
        function supportsStreamProcessing() {
            const hasReadableStream = 'ReadableStream' in window;
            const hasTextDecoder = 'TextDecoder' in window;
            const hasAsyncIterator = 'Symbol' in window && 'asyncIterator' in Symbol;
            const hasFetch = 'fetch' in window;
            
            // æ£€æµ‹æ˜¯å¦ä¸ºå¯èƒ½æœ‰æµå¼é—®é¢˜çš„æµè§ˆå™¨/è®¾å¤‡
            const ua = navigator.userAgent;
            const isOldBrowser = /MSIE|Trident|Edge\/12|Edge\/13|Edge\/14|Edge\/15|Edge\/16/.test(ua);
            const isProblematicMobile = isMobileSafari() && /OS 12_|OS 13_/.test(ua); // è€ç‰ˆæœ¬iOS Safari
            
            console.log('Stream support - ReadableStream:', hasReadableStream, 'TextDecoder:', hasTextDecoder, 'AsyncIterator:', hasAsyncIterator);
            console.log('Stream support - hasFetch:', hasFetch, 'isOldBrowser:', isOldBrowser, 'isProblematicMobile:', isProblematicMobile);
            
            return hasReadableStream && hasTextDecoder && hasFetch && !isOldBrowser && !isProblematicMobile;
        }

        // å®‰å…¨çš„JSONè§£æå‡½æ•°
        function safeJSONParse(jsonStr) {
            try {
                // å…ˆè¿›è¡ŒåŸºæœ¬çš„JSONæ ¼å¼æ£€æŸ¥
                if (!jsonStr || typeof jsonStr !== 'string') {
                    return null;
                }
                
                // æ¸…ç†å¯èƒ½çš„éJSONå­—ç¬¦
                const cleanStr = jsonStr.trim();
                if (!cleanStr.startsWith('{') || !cleanStr.endsWith('}')) {
                    return null;
                }
                
                // æ£€æŸ¥æ‹¬å·å¹³è¡¡
                const openBraces = (cleanStr.match(/\{/g) || []).length;
                const closeBraces = (cleanStr.match(/\}/g) || []).length;
                if (openBraces !== closeBraces) {
                    console.warn('Unbalanced JSON braces:', cleanStr);
                    return null;
                }
                
                return JSON.parse(cleanStr);
            } catch (e) {
                console.error('JSON parse error:', e.message, 'String:', jsonStr);
                return null;
            }
        }

        // å®æ—¶è¾“å…¥æ—¶è‡ªåŠ¨åˆ†æï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
        let debounceTimer;
        essayText.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const text = essayText.value.trim();
                const language = languageSelect.value;
                if (text) {
                    analyzeText(text, language);
                } else {
                    showInitialMessage();
                }
            }, 500); // 500ms å»¶è¿Ÿ
        });

        function analyzeText(text, language = 'zh') {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            statsResults.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">æ­£åœ¨ç»Ÿè®¡...</span>
                    </div>
                    <p class="mt-2 text-muted">æ­£åœ¨åˆ†ææ–‡æœ¬...</p>
                </div>
            `;

            // å‘é€è¯·æ±‚åˆ°åç«¯API
            fetch('/api/analyze-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    language: language
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.result);
                } else {
                    statsResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            åˆ†æå¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statsResults.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•
                    </div>
                `;
            });
        }

        function displayResults(result) {
            const language = languageSelect.value;

            // æ ¹æ®è¯­è¨€è°ƒæ•´æ˜¾ç¤ºå†…å®¹
            let mainCountLabel, mainCountValue, summaryText;

            if (language === 'zh') {
                mainCountLabel = 'æ±‰å­—';
                mainCountValue = result.main_count || result.chinese_chars || 0;
                summaryText = `å…±æ£€æµ‹åˆ° <span class="badge bg-primary">${mainCountValue}</span> ä¸ªæ±‰å­—`;
            } else {
                mainCountLabel = language === 'en' ? 'Words' : 'Palabras';
                mainCountValue = result.main_count || result.english_words || 0;
                const wordText = language === 'en' ? 'words' : 'palabras';
                summaryText = `å…±æ£€æµ‹åˆ° <span class="badge bg-primary">${mainCountValue}</span> ä¸ª${wordText}`;
            }

            statsResults.innerHTML = `
                <div class="row g-3">
                    <div class="col-6">
                        <div class="card bg-primary text-white h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-font fa-2x mb-2"></i>
                                <h4 class="mb-1">${mainCountValue}</h4>
                                <small>${mainCountLabel}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-warning text-white h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-quote-right fa-2x mb-2"></i>
                                <h4 class="mb-1">${result.punctuation}</h4>
                                <small>æ ‡ç‚¹ç¬¦å·</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-info text-white h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-list-ol fa-2x mb-2"></i>
                                <h4 class="mb-1">${result.total_chars}</h4>
                                <small>æ€»å­—ç¬¦</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-success text-white h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-globe fa-2x mb-2"></i>
                                <h4 class="mb-1">${result.language === 'zh' ? 'ä¸­æ–‡' : result.language === 'en' ? 'EN' : 'ES'}</h4>
                                <small>è¯­è¨€</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-light">
                        <strong>åˆ†æå®Œæˆï¼</strong> ${summaryText}
                    </div>
                </div>
            `;
        }

        function showInitialMessage() {
            statsResults.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    è¯·è¾“å…¥æ–‡æœ¬åç‚¹å‡»"ç»Ÿè®¡å­—æ•°"
                </div>
            `;
        }

        function showInitialCorrectionMessage() {
            correctionResults.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    è¯·è¾“å…¥ä½œæ–‡åç‚¹å‡»"AIæ‰¹æ”¹"
                </div>
            `;
        }

        function showAiThinkingPanel() {
            aiThinkingPanel.style.display = 'block';
            // ç¡®ä¿é¢æ¿æ˜¯å±•å¼€çš„
            const collapseElement = document.getElementById('aiThinkingContent');
            if (!collapseElement.classList.contains('show')) {
                const bsCollapse = new bootstrap.Collapse(collapseElement, { show: true });
            }
        }

        function hideAiThinkingPanel() {
            aiThinkingPanel.style.display = 'none';
        }

        function clearAiThinkingOutput() {
            aiThinkingOutput.innerHTML = '<div class="text-muted">ç­‰å¾…AIå¼€å§‹æ‰¹æ”¹...</div>';
            // ç§»é™¤æ‰€æœ‰current-lineç±»
            const currentLines = aiThinkingOutput.querySelectorAll('.current-line');
            currentLines.forEach(line => line.classList.remove('current-line'));
        }

        function appendToAiThinking(content) {
            // ç§»é™¤åˆå§‹æç¤º
            if (aiThinkingOutput.querySelector('.text-muted')) {
                aiThinkingOutput.innerHTML = '';
            }
            
            // è·å–æˆ–åˆ›å»ºå½“å‰è¡Œå…ƒç´ 
            let currentLine = aiThinkingOutput.querySelector('.current-line');
            if (!currentLine) {
                currentLine = document.createElement('div');
                currentLine.className = 'mb-1 current-line';
                aiThinkingOutput.appendChild(currentLine);
            }
            
            // å¤„ç†å†…å®¹
            const lines = content.split('\n');
            
            // å¤„ç†ç¬¬ä¸€è¡Œï¼ˆè¿½åŠ åˆ°å½“å‰è¡Œï¼‰
            if (lines.length > 0) {
                const firstLine = lines[0];
                currentLine.textContent += firstLine;
                
                // ä¸ºç‰¹æ®Šå†…å®¹æ·»åŠ æ ·å¼
                if (firstLine.includes('ğŸ“‹ å¼€å§‹åˆ†æï¼š')) {
                    currentLine.className = 'mb-1 text-primary fw-bold';
                } else if (firstLine.includes('å®Œæˆ') || firstLine.includes('æˆåŠŸ')) {
                    currentLine.className = 'mb-1 text-success';
                } else if (firstLine.includes('é”™è¯¯') || firstLine.includes('å¤±è´¥')) {
                    currentLine.className = 'mb-1 text-danger';
                } else if (firstLine.includes('##')) {
                    currentLine.className = 'mb-1 text-info fw-bold';
                }
            }
            
            // å¤„ç†åç»­è¡Œï¼ˆå¦‚æœæœ‰æ¢è¡Œç¬¦ï¼‰
            for (let i = 1; i < lines.length; i++) {
                // å®Œæˆå½“å‰è¡Œ
                currentLine.classList.remove('current-line');
                
                // åˆ›å»ºæ–°è¡Œ
                const newLine = document.createElement('div');
                newLine.className = 'mb-1 current-line';
                newLine.textContent = lines[i];
                
                // ä¸ºç‰¹æ®Šå†…å®¹æ·»åŠ æ ·å¼
                if (lines[i].includes('ğŸ“‹ å¼€å§‹åˆ†æï¼š')) {
                    newLine.className = 'mb-1 text-primary fw-bold current-line';
                } else if (lines[i].includes('å®Œæˆ') || lines[i].includes('æˆåŠŸ')) {
                    newLine.className = 'mb-1 text-success current-line';
                } else if (lines[i].includes('é”™è¯¯') || lines[i].includes('å¤±è´¥')) {
                    newLine.className = 'mb-1 text-danger current-line';
                } else if (lines[i].includes('##')) {
                    newLine.className = 'mb-1 text-info fw-bold current-line';
                }
                
                aiThinkingOutput.appendChild(newLine);
                currentLine = newLine;
            }
            
            // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
            aiThinkingOutput.scrollTo({
                top: aiThinkingOutput.scrollHeight,
                behavior: 'smooth'
            });
            
            // å¦‚æœå†…å®¹å¤ªå¤šï¼Œä¿æŒæœ€æ–°çš„100è¡Œ
            while (aiThinkingOutput.children.length > 100) {
                aiThinkingOutput.removeChild(aiThinkingOutput.firstChild);
            }
        }

        // æ·»åŠ æ‰“å­—æœºæ•ˆæœçš„å®æ—¶è¾“å‡º
        function appendToAiThinkingWithTyping(content) {
            const lines = content.split('\n');
            let currentLineIndex = 0;
            
            function typeLine() {
                if (currentLineIndex >= lines.length) return;
                
                const line = lines[currentLineIndex];
                const lineElement = document.createElement('div');
                lineElement.className = 'mb-1 fade-in';
                lineElement.textContent = '';
                
                // åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                if (line.includes('æ­£åœ¨åˆ†æ') || line.includes('å¼€å§‹')) {
                    lineElement.className += ' text-primary';
                } else if (line.includes('å®Œæˆ') || line.includes('æˆåŠŸ')) {
                    lineElement.className += ' text-success';
                } else if (line.includes('é”™è¯¯') || line.includes('å¤±è´¥')) {
                    lineElement.className += ' text-danger';
                } else if (line.includes('æ€è€ƒ') || line.includes('å¤„ç†')) {
                    lineElement.className += ' text-info';
                }
                
                aiThinkingOutput.appendChild(lineElement);
                
                // æ‰“å­—æœºæ•ˆæœ
                let charIndex = 0;
                const typingInterval = setInterval(() => {
                    if (charIndex < line.length) {
                        lineElement.textContent += line[charIndex];
                        charIndex++;
                    } else {
                        clearInterval(typingInterval);
                        currentLineIndex++;
                        setTimeout(typeLine, 100); // çŸ­æš‚åœé¡¿åç»§ç»­ä¸‹ä¸€è¡Œ
                    }
                }, 50); // 50ms per character
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                aiThinkingOutput.scrollTo({
                    top: aiThinkingOutput.scrollHeight,
                    behavior: 'smooth'
                });
            }
            
            // ç§»é™¤åˆå§‹æç¤º
            if (aiThinkingOutput.querySelector('.text-muted')) {
                aiThinkingOutput.innerHTML = '';
            }
            
            typeLine();
        }

        function correctEssay(text, language = 'zh') {
            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!checkNetworkStatus()) {
                correctionResults.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-wifi me-2"></i>
                        ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®
                    </div>
                `;
                return;
            }
            
            // è·å–é€‰æ‹©å™¨çš„å€¼
            const wordCount = wordCountSelect.value;
            const grade = gradeSelect.value;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            correctionResults.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">æ­£åœ¨æ‰¹æ”¹...</span>
                    </div>
                    <p class="mt-2 text-muted">AIæ­£åœ¨æ‰¹æ”¹ä½œæ–‡ï¼Œè¯·ç¨å€™...</p>
                    <small class="text-muted">è¿™å¯èƒ½éœ€è¦10-30ç§’æ—¶é—´</small>
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fas fa-info-circle me-1"></i>
                            å¹´çº§ï¼š${grade} | å­—æ•°ï¼š${wordCount}
                        </small>
                    </div>
                </div>
            `;

            // æ˜¾ç¤ºAIæ€è€ƒé¢æ¿
            showAiThinkingPanel();
            clearAiThinkingOutput();
            aiThinkingTitle.textContent = 'AIæ­£åœ¨æ€è€ƒ...';

            // æ™ºèƒ½é€‰æ‹©å¤„ç†æ¨¡å¼ï¼šä¼˜å…ˆå°è¯•æµå¼ï¼Œä½†ä¸ºç§»åŠ¨è®¾å¤‡æä¾›æ›´å¥½çš„é™çº§ç­–ç•¥
            const preferFallback = !supportsStreamProcessing() || (isMobileDevice() && navigator.connection && navigator.connection.effectiveType && navigator.connection.effectiveType.includes('2g'));
            const forceStream = localStorage.getItem('forceStreamMode') === 'true'; // å…è®¸ç”¨æˆ·å¼ºåˆ¶å¯ç”¨æµå¼æ¨¡å¼
            
            console.log('Device check - preferFallback:', preferFallback, 'forceStream:', forceStream);
            
            if (preferFallback && !forceStream) {
                console.log('Using fallback for better mobile experience');
                appendToAiThinking('æ£€æµ‹åˆ°è¾ƒæ…¢çš„ç½‘ç»œæˆ–ç§»åŠ¨è®¾å¤‡ï¼Œä½¿ç”¨ç¨³å®šæ‰¹æ”¹æ¨¡å¼...\n');
                setTimeout(() => {
                    fallbackCorrectEssay(text, language);
                }, 100);
                return;
            }

            // ä½¿ç”¨fetchæµå¼è¾“å‡ºï¼Œå¢åŠ é”™è¯¯å¤„ç†å’Œå…¼å®¹æ€§
            let streamFinished = false;
            let dataBuffer = ''; // æ•°æ®ç¼“å†²åŒºï¼Œå¤„ç†ä¸å®Œæ•´çš„æ•°æ®
            let timeoutId = null; // è¶…æ—¶å¤„ç†
            
            // åŠ¨æ€è¶…æ—¶è®¾ç½®ï¼šç§»åŠ¨è®¾å¤‡ä½¿ç”¨æ›´é•¿è¶…æ—¶æ—¶é—´
            const timeoutDuration = isMobileDevice() ? 180000 : 120000; // ç§»åŠ¨è®¾å¤‡3åˆ†é’Ÿï¼Œæ¡Œé¢è®¾å¤‡2åˆ†é’Ÿ
            
            timeoutId = setTimeout(() => {
                if (!streamFinished) {
                    console.log(`Stream timeout after ${timeoutDuration/1000}s, falling back to regular request`);
                    streamFinished = true;
                    appendToAiThinking('\nâ° æµå¼å¤„ç†è¶…æ—¶ï¼Œæ­£åœ¨åˆ‡æ¢åˆ°ç¨³å®šæ¨¡å¼...\n');
                    // ç»™ç”¨æˆ·æ›´å‹å¥½çš„æç¤º
                    appendToAiThinking('ğŸ’¡ æç¤ºï¼šå¦‚æœç»å¸¸è¶…æ—¶ï¼Œå¯ä»¥åˆ·æ–°é¡µé¢åå°è¯•ç›´æ¥ä½¿ç”¨ç¨³å®šæ¨¡å¼\n');
                    fallbackCorrectEssay(text, language);
                }
            }, timeoutDuration);
            
            fetch('/api/correct-essay-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    word_count: wordCount,
                    grade: grade,
                    language: language
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                // æ·»åŠ å¿ƒè·³æ£€æµ‹
                let lastActivityTime = Date.now();
                const heartbeatInterval = setInterval(() => {
                    if (streamFinished) {
                        clearInterval(heartbeatInterval);
                        return;
                    }
                    
                    const timeSinceLastActivity = Date.now() - lastActivityTime;
                    if (timeSinceLastActivity > 45000) { // 45ç§’æ— æ´»åŠ¨
                        appendToAiThinking('â³ æ­£åœ¨ç­‰å¾…AIå“åº”ï¼Œè¯·è€å¿ƒç­‰å¾…...\n');
                        lastActivityTime = Date.now(); // é‡ç½®è®¡æ—¶å™¨
                    }
                }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done || streamFinished) {
                            clearInterval(heartbeatInterval);
                            // å¤„ç†å‰©ä½™ç¼“å†²åŒºæ•°æ®
                            if (dataBuffer.trim()) {
                                processBufferedData(dataBuffer);
                            }
                            return;
                        }
                        
                        lastActivityTime = Date.now(); // æ›´æ–°æ´»åŠ¨æ—¶é—´
                        
                        const chunk = decoder.decode(value, { stream: true });
                        dataBuffer += chunk;
                        
                        // å¤„ç†å®Œæ•´çš„è¡Œ
                        const lines = dataBuffer.split('\n');
                        dataBuffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€è¡Œï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰
                        
                        lines.forEach(line => {
                            if (line.trim() && line.startsWith('data: ')) {
                                const jsonStr = line.substring(6).trim();
                                if (jsonStr) {
                                    const data = safeJSONParse(jsonStr);
                                    
                                    if (data) {
                                        if (data.type === 'thinking') {
                                            // æ˜¾ç¤ºAIæ€è€ƒè¿‡ç¨‹
                                            appendToAiThinking(data.content);
                                        } else if (data.type === 'result') {
                                            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                                            streamFinished = true;
                                            if (timeoutId) {
                                                clearTimeout(timeoutId);
                                                timeoutId = null;
                                            }
                                            aiThinkingTitle.textContent = 'AIæ‰¹æ”¹å®Œæˆ';
                                            displayCorrectionResults(data.corrections);
                                            // å…³é—­è¯»å–å™¨
                                            reader.cancel();
                                            return;
                                        } else if (data.type === 'error') {
                                            // æ˜¾ç¤ºé”™è¯¯
                                            streamFinished = true;
                                            if (timeoutId) {
                                                clearTimeout(timeoutId);
                                                timeoutId = null;
                                            }
                                            aiThinkingTitle.textContent = 'AIæ‰¹æ”¹å¤±è´¥';
                                            correctionResults.innerHTML = `
                                                <div class="alert alert-danger">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    æ‰¹æ”¹å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}
                                                </div>
                                            `;
                                            reader.cancel();
                                            return;
                                        }
                                    } else {
                                        // æ— æ•ˆçš„JSONæ•°æ®ï¼Œè®°å½•ä½†ä¸ä¸­æ–­æµç¨‹
                                        console.warn('Invalid JSON data received:', line);
                                    }
                                }
                            }
                        });
                        
                        // ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªchunkï¼ˆå¦‚æœæµæ²¡æœ‰ç»“æŸï¼‰
                        if (!streamFinished) {
                            return readStream();
                        }
                    }).catch(error => {
                        console.error('Stream read error:', error);
                        clearInterval(heartbeatInterval);
                        if (!streamFinished) {
                            streamFinished = true;
                            if (timeoutId) {
                                clearTimeout(timeoutId);
                                timeoutId = null;
                            }
                            
                            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„å¤„ç†
                            if (error.name === 'AbortError' || error.message.includes('aborted')) {
                                appendToAiThinking('\nâš ï¸ è¿æ¥è¢«ä¸­æ–­ï¼Œæ­£åœ¨å°è¯•ç¨³å®šæ¨¡å¼...\n');
                            } else if (error.message.includes('network') || error.message.includes('fetch')) {
                                appendToAiThinking('\nğŸŒ ç½‘ç»œé—®é¢˜ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...\n');
                            } else {
                                appendToAiThinking('\nâš ï¸ æµå¼ä¼ è¾“é‡åˆ°é—®é¢˜ï¼Œæ­£åœ¨åˆ‡æ¢åˆ°ç¨³å®šæ¨¡å¼...\n');
                            }
                            
                            fallbackCorrectEssay(text, language);
                        }
                    });
                }
                
                // å¤„ç†ç¼“å†²åŒºä¸­å‰©ä½™çš„æ•°æ®
                function processBufferedData(buffer) {
                    console.log('Processing buffered data:', buffer);
                    const lines = buffer.split('\n');
                    lines.forEach(line => {
                        if (line.trim() && line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (jsonStr) {
                                const data = safeJSONParse(jsonStr);
                                if (data && data.type === 'result') {
                                    if (timeoutId) {
                                        clearTimeout(timeoutId);
                                        timeoutId = null;
                                    }
                                    streamFinished = true;
                                    aiThinkingTitle.textContent = 'AIæ‰¹æ”¹å®Œæˆ';
                                    displayCorrectionResults(data.corrections);
                                } else if (data && data.type === 'thinking') {
                                    // å¤„ç†æ€è€ƒè¿‡ç¨‹æ•°æ®
                                    appendToAiThinking(data.content);
                                } else {
                                    console.warn('Invalid buffered JSON data:', line);
                                }
                            }
                        }
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                console.error('Stream error:', error);
                if (!streamFinished) {
                    streamFinished = true;
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                        timeoutId = null;
                    }
                    aiThinkingTitle.textContent = 'AIæ‰¹æ”¹å¤±è´¥';
                    // å¦‚æœæµå¼è¾“å‡ºå¤±è´¥ï¼Œå°è¯•æ™®é€šè¯·æ±‚
                    fallbackCorrectEssay(text, language);
                }
            });
        }

        function fallbackCorrectEssay(text, language = 'zh') {
            console.log('fallbackCorrectEssay called');
            
            // è·å–é€‰æ‹©å™¨çš„å€¼
            const wordCount = wordCountSelect.value;
            const grade = gradeSelect.value;
            
            // æ¨¡æ‹ŸAIæ€è€ƒè¿‡ç¨‹ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
            appendToAiThinking('ğŸ”„ æ­£åœ¨è¿æ¥AIæœåŠ¡ï¼ˆç¨³å®šæ¨¡å¼ï¼‰...\n');
            
            const feedbackSteps = [
                { delay: 500, message: 'ğŸ“‹ æ­£åœ¨åˆ†æä½œæ–‡å†…å®¹...' },
                { delay: 1500, message: 'ğŸ¤– AIæ­£åœ¨ç»†è‡´æ£€æŸ¥è¯­æ³•å’Œæ‹¼å†™...' },
                { delay: 3000, message: 'ğŸ” æ­£åœ¨åˆ†ææ–‡ç« ç»“æ„å’Œé€»è¾‘...' },
                { delay: 5000, message: 'âœï¸ æ­£åœ¨ç”Ÿæˆè¯¦ç»†çš„ä¿®æ”¹å»ºè®®...' }
            ];
            
            feedbackSteps.forEach(step => {
                setTimeout(() => {
                    if (!aiThinkingOutput.textContent.includes('âœ…') && !aiThinkingOutput.textContent.includes('âŒ')) {
                        appendToAiThinking(step.message + '\n');
                    }
                }, step.delay);
            });
            
            // å¢åŠ é‡è¯•æœºåˆ¶çš„æ™®é€šè¯·æ±‚
            const maxRetries = 2;
            let retryCount = 0;
            
            function attemptFallbackRequest() {
                return fetch('/api/correct-essay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        word_count: wordCount,
                        grade: grade,
                        language: language
                    }),
                    timeout: 120000 // 2åˆ†é’Ÿè¶…æ—¶
                })
                .catch(error => {
                    console.error(`Attempt ${retryCount + 1} failed:`, error);
                    retryCount++;
                    
                    if (retryCount < maxRetries) {
                        appendToAiThinking(`\nâš ï¸ ç¬¬${retryCount}æ¬¡è¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...\n`);
                        return new Promise(resolve => {
                            setTimeout(() => resolve(attemptFallbackRequest()), 2000 * retryCount); // é€’å¢å»¶è¿Ÿ
                        });
                    } else {
                        throw error;
                    }
                });
            }
            
            attemptFallbackRequest()
            .then(response => {
                console.log('Fallback response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Fallback response data:', data);
                
                if (data.success) {
                    appendToAiThinking('âœ… AIåˆ†æå®Œæˆï¼Œæ­£åœ¨æ•´ç†æ‰¹æ”¹ç»“æœ...\n');
                    
                    // ç¡®ä¿åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œï¼Œè®©æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºå®Œæˆ
                    setTimeout(() => {
                        aiThinkingTitle.textContent = 'AIæ‰¹æ”¹å®Œæˆ';
                        
                        // å¼ºåˆ¶ç¡®ä¿correctionResultså­˜åœ¨
                        if (!correctionResults) {
                            console.error('correctionResults element not found in DOM');
                            return;
                        }
                        
                        console.log('About to call displayCorrectionResults with:', data.corrections);
                        displayCorrectionResults(data.corrections);
                        
                        // æ˜¾ç¤ºAIåŸå§‹å“åº”ï¼ˆä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼‰
                        if (data.raw_response && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
                            appendToAiThinking('\n--- AIåŸå§‹å“åº” ---\n' + data.raw_response);
                        }
                    }, 500);
                } else {
                    aiThinkingTitle.textContent = 'AIæ‰¹æ”¹å¤±è´¥';
                    appendToAiThinking('âŒ æ‰¹æ”¹å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯') + '\n');
                    correctionResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            æ‰¹æ”¹å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('All fallback attempts failed:', error);
                aiThinkingTitle.textContent = 'AIæ‰¹æ”¹å¤±è´¥';
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å…·ä½“çš„å»ºè®®
                let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                let suggestions = [];
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
                    suggestions = ['æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸', 'å°è¯•åˆ·æ–°é¡µé¢', 'ç¨åå†è¯•'];
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶';
                    suggestions = ['ç½‘ç»œè¾ƒæ…¢ï¼Œè¯·ç¼©çŸ­ä½œæ–‡é•¿åº¦', 'å°è¯•åœ¨ç½‘ç»œçŠ¶æ€è‰¯å¥½æ—¶é‡è¯•', 'åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹'];
                } else if (error.message.includes('500')) {
                    errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
                    suggestions = ['æœåŠ¡å™¨æ­£åœ¨å¤„ç†å¤§é‡è¯·æ±‚ï¼Œè¯·ç¨åå†è¯•', 'å°è¯•åˆ·æ–°é¡µé¢'];
                }
                
                appendToAiThinking(`\nâŒ æ‰¹æ”¹å¤±è´¥ï¼š${errorMessage}\n`);
                
                const suggestionsHtml = suggestions.length > 0 ? 
                    `<div class="mt-2"><small class="text-muted">
                        å»ºè®®ï¼š<br>
                        ${suggestions.map((s, i) => `${i + 1}. ${s}`).join('<br>')}
                    </small></div>` : '';
                
                correctionResults.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>æ‰¹æ”¹å¤±è´¥</strong><br>
                        ${errorMessage}
                        ${suggestionsHtml}
                        <div class="mt-3">
                            <button class="btn btn-outline-danger btn-sm" onclick="correctEssay(essayText.value.trim())">
                                <i class="fas fa-redo me-1"></i>é‡è¯•
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="localStorage.setItem('forceStreamMode', 'true'); correctEssay(essayText.value.trim())">
                                <i class="fas fa-stream me-1"></i>å¼ºåˆ¶ä½¿ç”¨æµå¼æ¨¡å¼
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        // æ·»åŠ ç½‘ç»œçŠ¶æ€æ£€æµ‹
        function checkNetworkStatus() {
            if ('navigator' in window && 'onLine' in navigator) {
                if (!navigator.onLine) {
                    appendToAiThinking('\nâš ï¸ æ£€æµ‹åˆ°ç½‘ç»œæ–­å¼€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥\n');
                    return false;
                }
            }
            
            if ('navigator' in window && 'connection' in navigator) {
                const connection = navigator.connection;
                if (connection && connection.effectiveType) {
                    if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                        appendToAiThinking('\nğŸŒ æ£€æµ‹åˆ°ç½‘ç»œè¾ƒæ…¢ï¼Œå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´...\n');
                    }
                }
            }
            
            return true;
        }

        function displayCorrectionResults(corrections) {
            console.log('displayCorrectionResults called with:', corrections);
            console.log('correctionResults element:', correctionResults);
            
            // ç§»é™¤å½“å‰è¡Œçš„å…‰æ ‡æ•ˆæœ
            const currentLines = aiThinkingOutput.querySelectorAll('.current-line');
            currentLines.forEach(line => line.classList.remove('current-line'));
            
            // å¼ºåˆ¶ç¡®ä¿correctionResultså…ƒç´ å­˜åœ¨
            if (!correctionResults) {
                console.error('correctionResults element not found in DOM');
                // å°è¯•é‡æ–°è·å–å…ƒç´ 
                const element = document.getElementById('correctionResults');
                if (element) {
                    console.log('Found correctionResults by getElementById');
                    // æ›´æ–°å…¨å±€å˜é‡
                    window.correctionResults = element;
                } else {
                    console.error('correctionResults element still not found');
                    alert('ç•Œé¢é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ‰¹æ”¹ç»“æœæ˜¾ç¤ºåŒºåŸŸï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
            }
            
            // æ·»åŠ åŠ è½½æç¤ºï¼Œç¡®ä¿ç”¨æˆ·çŸ¥é“ç»“æœæ­£åœ¨æ˜¾ç¤º
            correctionResults.innerHTML = `
                <div class="text-center p-3">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">æ­£åœ¨æ˜¾ç¤ºç»“æœ...</span>
                    </div>
                    <p class="mt-2 text-muted">æ­£åœ¨æ•´ç†æ‰¹æ”¹ç»“æœ...</p>
                </div>
            `;
            
            // å»¶è¿Ÿæ˜¾ç¤ºç»“æœï¼Œç¡®ä¿UIæœ‰æ—¶é—´æ›´æ–°
            setTimeout(() => {
                if (!corrections || corrections.length === 0) {
                    correctionResults.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>æ­å–œï¼</strong>æ‚¨çš„ä½œæ–‡æš‚æœªå‘ç°æ˜æ˜¾é—®é¢˜ã€‚
                        </div>
                    `;
                    return;
                }
                
                displayActualResults(corrections);
            }, 300);
        }

        function displayActualResults(corrections) {

            let html = '<div class="accordion" id="correctionAccordion">';
            
            corrections.forEach((section, index) => {
                if (!section || !section.type || !section.items) {
                    console.warn('Invalid section:', section);
                    return;
                }
                
                const sectionId = `section${index}`;
                const iconMap = {
                    'æ€»ä½“è¯„ä»·': 'fas fa-star text-success',
                    'ç—…å¥ä¿®æ”¹': 'fas fa-exclamation-triangle text-warning',
                    'é”™åˆ«å­—ä¿®æ”¹': 'fas fa-spell-check text-danger',
                    'æ ‡ç‚¹ç¬¦å·ä¿®æ”¹': 'fas fa-quote-right text-info',
                    'è¯­è¨€è¡¨è¾¾æ”¹è¿›å»ºè®®': 'fas fa-lightbulb text-primary',
                    'å†…å®¹ç»“æ„æ”¹è¿›å»ºè®®': 'fas fa-list-alt text-secondary'
                };
                
                const icon = iconMap[section.type] || 'fas fa-edit';
                const isFirst = index === 0;
                
                html += `
                    <div class="accordion-item">
                        <h6 class="accordion-header" id="heading${sectionId}">
                            <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapse${sectionId}" 
                                    aria-expanded="${isFirst}" aria-controls="collapse${sectionId}">
                                <i class="${icon} me-2"></i>
                                ${section.type} (${section.items.length}é¡¹)
                            </button>
                        </h6>
                        <div id="collapse${sectionId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" 
                             aria-labelledby="heading${sectionId}" data-bs-parent="#correctionAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled mb-0">
                `;
                
                section.items.forEach((item, itemIndex) => {
                    if (typeof item === 'string') {
                        html += `<li class="mb-2"><i class="fas fa-angle-right me-2 text-muted"></i>${item}</li>`;
                    } else {
                        console.warn('Invalid item at index', itemIndex, ':', item);
                    }
                });
                
                html += `
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // æ·»åŠ æ€»ç»“ä¿¡æ¯
            const totalIssues = corrections.reduce((sum, section) => {
                return sum + (section.items ? section.items.length : 0);
            }, 0);
            
            html = `
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>æ‰¹æ”¹å®Œæˆï¼</strong> å‘ç° <span class="badge bg-warning text-dark">${totalIssues}</span> å¤„éœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚
                </div>
            ` + html;
            
            // è®¾ç½®ç»“æœå†…å®¹
            correctionResults.innerHTML = html;
            
            // å¼ºåˆ¶åˆ·æ–°æ˜¾ç¤ºï¼ˆç‰¹åˆ«é’ˆå¯¹iPad Safariï¼‰
            if (isMobileSafari()) {
                // å¼ºåˆ¶é‡æ–°æ¸²æŸ“
                correctionResults.style.display = 'none';
                setTimeout(() => {
                    correctionResults.style.display = 'block';
                    
                    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                    correctionResults.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 50);
            }
            
            // æ·»åŠ å®Œæˆæç¤ºåˆ°AIæ€è€ƒè¾“å‡º
            appendToAiThinking(`\nâœ… æ‰¹æ”¹ç»“æœå·²æ˜¾ç¤ºï¼Œå…±å‘ç° ${totalIssues} å¤„éœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚\n`);
            
            console.log('Correction results displayed successfully');
            
            // è®¾ç½®ä¸€ä¸ªéªŒè¯æœºåˆ¶ï¼Œç¡®ä¿ç»“æœç¡®å®æ˜¾ç¤ºäº†
            setTimeout(() => {
                const resultContent = correctionResults.querySelector('.accordion');
                if (!resultContent) {
                    console.warn('Results may not have displayed properly, attempting recovery');
                    // å†æ¬¡å°è¯•æ˜¾ç¤º
                    correctionResults.innerHTML = html;
                }
            }, 1000);
        }
    </script>
</body>
</html> 