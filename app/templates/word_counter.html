<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>作文字数统计 - 超能力训练场</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 响应式设计 */
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .col-md-7, .col-md-5 {
                width: 100%;
                max-width: 100%;
                margin-bottom: 1rem;
            }
            
            #aiThinkingOutput {
                height: 150px !important;
                font-size: 0.8em !important;
            }
            
            .btn {
                margin-bottom: 0.5rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .card-body {
                padding: 1rem !important;
            }
        }
        
        /* AI思考输出样式 */
        #aiThinkingOutput {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        #aiThinkingOutput:hover {
            background-color: #e9ecef;
        }
        
        /* 折叠按钮样式 */
        .btn-link {
            border: none !important;
            box-shadow: none !important;
        }
        
        .btn-link:focus {
            box-shadow: none !important;
        }
        
        /* 手风琴样式 */
        .accordion-button {
            padding: 0.75rem 1rem;
            font-weight: 500;
        }
        
        .accordion-button:not(.collapsed) {
            background-color: #e7f3ff;
            border-color: #b3d9ff;
        }
        
        /* 滚动条样式 */
        #aiThinkingOutput::-webkit-scrollbar {
            width: 8px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 动画效果 */
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 正在输入行的光标效果 */
        .current-line::after {
            content: '▊';
            color: #007bff;
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* AI思考过程栏样式 */
        #aiThinkingOutput {
            transition: height 0.2s ease;
        }
        
        #aiThinkingOutput::-webkit-scrollbar {
            width: 8px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        #aiThinkingOutput::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 调节高度的提示 */
        .resize-hint {
            position: absolute;
            bottom: 2px;
            right: 2px;
            color: #ccc;
            font-size: 12px;
            pointer-events: none;
        }
        
        /* 移动设备优化 */
        @media (max-width: 576px) {
            .container {
                padding: 0 10px;
            }
            
            .btn {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
            
            #aiThinkingOutput {
                height: 120px !important;
                font-size: 0.75em !important;
            }
            
            .card-header h5, .card-header h6 {
                font-size: 1rem;
            }
            
            /* 修复移动端AI批改结果显示 */
            #correctionResults .accordion-button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            #correctionResults .accordion-body {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            #correctionResults .alert {
                padding: 0.5rem;
                margin-bottom: 0.75rem;
            }
            
            /* 确保在移动设备上accordion能正常工作 */
            .accordion-collapse {
                transition: height 0.3s ease;
            }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="mb-4">作文字数统计</h1>
        
        {% include '_navigation.html' %}

        <div class="row">
            <!-- 文本输入和AI批改结果区域 -->
            <div class="col-md-7">
                <!-- 作文输入框 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-edit me-2"></i>输入您的作文
                        </h5>
                    </div>
                    <div class="card-body">
                        <textarea
                            id="essayText"
                            class="form-control"
                            rows="10"
                            placeholder="请在此处输入您的作文内容..."
                            style="resize: vertical; min-height: 250px;"
                        ></textarea>
                        <!-- 作文要求选择器 -->
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="languageSelect" class="form-label small">
                                        <i class="fas fa-globe me-1"></i>语言
                                    </label>
                                    <select id="languageSelect" class="form-select form-select-sm">
                                        <option value="zh" selected>中文</option>
                                        <option value="en">English</option>
                                        <option value="es">Español</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="wordCountSelect" class="form-label small">
                                        <i class="fas fa-ruler me-1"></i><span id="wordCountLabel">作文字数要求</span>
                                    </label>
                                    <select id="wordCountSelect" class="form-select form-select-sm">
                                        <!-- 动态填充选项 -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="gradeSelect" class="form-label small">
                                        <i class="fas fa-graduation-cap me-1"></i>年级
                                    </label>
                                    <select id="gradeSelect" class="form-select form-select-sm">
                                        <option value="一年级">一年级</option>
                                        <option value="二年级">二年级</option>
                                        <option value="三年级" selected>三年级</option>
                                        <option value="四年级">四年级</option>
                                        <option value="五年级">五年级</option>
                                        <option value="六年级">六年级</option>
                                        <option value="初一">初一</option>
                                        <option value="初二">初二</option>
                                        <option value="初三">初三</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button id="clearBtn" class="btn btn-outline-danger">
                                <i class="fas fa-trash me-1"></i>清空
                            </button>
                            <button id="analyzeBtn" class="btn btn-primary ms-2">
                                <i class="fas fa-calculator me-1"></i>统计字数
                            </button>
                            <button id="correctBtn" class="btn btn-success ms-2">
                                <i class="fas fa-edit me-1"></i>AI批改
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI批改结果区域 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-robot me-2 text-success"></i>AI批改结果
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="correctionResults">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                请输入作文后点击"AI批改"
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧信息和调试区域 -->
            <div class="col-md-5">
                <!-- 统计结果区域 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>统计结果
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="statsResults">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                请输入文本后点击"统计字数"
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI思考过程面板 -->
                <div id="aiThinkingPanel" class="card mt-3" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-brain me-2 text-info"></i>
                                <span id="aiThinkingTitle">AI正在思考...</span>
                            </h6>
                            <div>
                                <button id="clearThinkingBtn" class="btn btn-sm btn-outline-secondary me-2">
                                    <i class="fas fa-eraser"></i>
                                </button>
                                <a data-bs-toggle="collapse" href="#aiThinkingContent" role="button" aria-expanded="true" aria-controls="aiThinkingContent">
                                    <i id="aiThinkingChevron" class="fas fa-chevron-up text-secondary"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div id="aiThinkingContent" class="collapse show">
                        <div class="card-body p-0">
                            <div id="aiThinkingOutput" class="p-3">
                                <div class="text-muted">等待AI开始批改...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 统计说明 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-question-circle me-2"></i>功能说明
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled small text-muted">
                            <li><i class="fas fa-dot-circle me-2"></i>汉字：中文字符数量</li>
                            <li><i class="fas fa-dot-circle me-2"></i>标点：中英文标点符号</li>
                            <li><i class="fas fa-dot-circle me-2"></i>英文单词：连续字母组成的单词</li>
                            <li><i class="fas fa-dot-circle me-2"></i>总字符：包含所有字符</li>
                            <li><i class="fas fa-dot-circle me-2 text-success"></i>AI批改：检查病句、错别字、标点等</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const essayText = document.getElementById('essayText');
        const clearBtn = document.getElementById('clearBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const correctBtn = document.getElementById('correctBtn');
        const statsResults = document.getElementById('statsResults');
        const correctionResults = document.getElementById('correctionResults');
        const aiThinkingPanel = document.getElementById('aiThinkingPanel');
        const aiThinkingOutput = document.getElementById('aiThinkingOutput');
        const aiThinkingTitle = document.getElementById('aiThinkingTitle');
        const aiThinkingChevron = document.getElementById('aiThinkingChevron');
        const clearThinkingBtn = document.getElementById('clearThinkingBtn');
        const wordCountSelect = document.getElementById('wordCountSelect');
        const gradeSelect = document.getElementById('gradeSelect');
        const languageSelect = document.getElementById('languageSelect');
        const wordCountLabel = document.getElementById('wordCountLabel');

        // 语言对应的字数选项配置
        const wordCountOptions = {
            'zh': {
                label: '作文字数要求',
                options: [
                    { value: '不限字数', text: '不限字数' },
                    { value: '300字左右', text: '300字左右' },
                    { value: '400字左右', text: '400字左右' },
                    { value: '500字左右', text: '500字左右' },
                    { value: '600字左右', text: '600字左右' },
                    { value: '700字左右', text: '700字左右' },
                    { value: '1000字左右', text: '1000字左右' },
                    { value: '1500字以上', text: '1500字以上' }
                ]
            },
            'en': {
                label: 'Word Count Requirement',
                options: [
                    { value: 'No limit', text: 'No limit' },
                    { value: '60 words', text: '60 words' },
                    { value: '80 words', text: '80 words' },
                    { value: '100 words', text: '100 words' },
                    { value: '150 words', text: '150 words' },
                    { value: '200 words', text: '200 words' },
                    { value: '300 words', text: '300 words' },
                    { value: '500 words', text: '500 words' },
                    { value: '1000 words', text: '1000 words' }
                ]
            },
            'es': {
                label: 'Requisito de Palabras',
                options: [
                    { value: 'Sin límite', text: 'Sin límite' },
                    { value: '60 palabras', text: '60 palabras' },
                    { value: '80 palabras', text: '80 palabras' },
                    { value: '100 palabras', text: '100 palabras' },
                    { value: '150 palabras', text: '150 palabras' },
                    { value: '200 palabras', text: '200 palabras' },
                    { value: '300 palabras', text: '300 palabras' },
                    { value: '500 palabras', text: '500 palabras' },
                    { value: '1000 palabras', text: '1000 palabras' }
                ]
            }
        };

        // 更新字数选项
        function updateWordCountOptions(language) {
            const config = wordCountOptions[language];
            wordCountLabel.textContent = config.label;

            // 清空现有选项
            wordCountSelect.innerHTML = '';

            // 添加新选项
            config.options.forEach((option, index) => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                if (index === 0) optionElement.selected = true; // 默认选择第一个
                wordCountSelect.appendChild(optionElement);
            });
        }

        // 语言切换事件监听
        languageSelect.addEventListener('change', function() {
            const selectedLanguage = this.value;
            updateWordCountOptions(selectedLanguage);

            // 重新分析文本（如果有内容的话）
            const text = essayText.value.trim();
            if (text) {
                analyzeText(text, selectedLanguage);
            }
        });

        // 初始化字数选项（默认中文）
        updateWordCountOptions('zh');

        // 验证关键元素是否存在
        console.log('DOM Elements verification:');
        console.log('essayText:', essayText);
        console.log('correctionResults:', correctionResults);
        console.log('aiThinkingOutput:', aiThinkingOutput);
        console.log('wordCountSelect:', wordCountSelect);
        console.log('gradeSelect:', gradeSelect);
        console.log('languageSelect:', languageSelect);
        
        // 如果关键元素缺失，显示错误信息
        if (!correctionResults) {
            console.error('Critical: correctionResults element not found!');
            alert('页面加载异常，correctionResults元素未找到，请刷新页面');
        }
        
        if (!aiThinkingOutput) {
            console.error('Critical: aiThinkingOutput element not found!');
        }
        
        // 全局错误处理
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            if (e.error && e.error.message && e.error.message.includes('JSON')) {
                console.warn('JSON parsing error detected, this is handled gracefully');
            }
        });
        
        // 添加页面可见性变化监听（针对移动端背景切换问题）
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isMobileSafari()) {
                // 页面重新可见时，检查是否有未完成的批改任务
                console.log('Page became visible on mobile Safari');
            }
        });

        // 清空文本
        clearBtn.addEventListener('click', function() {
            essayText.value = '';
            showInitialMessage();
            showInitialCorrectionMessage();
            hideAiThinkingPanel();
        });

        // 清空AI思考输出
        clearThinkingBtn.addEventListener('click', function() {
            clearAiThinkingOutput();
        });

        // 监听折叠状态变化
        document.getElementById('aiThinkingContent').addEventListener('show.bs.collapse', function () {
            aiThinkingChevron.classList.remove('fa-chevron-down');
            aiThinkingChevron.classList.add('fa-chevron-up');
        });

        document.getElementById('aiThinkingContent').addEventListener('hide.bs.collapse', function () {
            aiThinkingChevron.classList.remove('fa-chevron-up');
            aiThinkingChevron.classList.add('fa-chevron-down');
        });

        // 分析文本
        analyzeBtn.addEventListener('click', function() {
            const text = essayText.value.trim();
            if (!text) {
                alert('请先输入文本内容');
                return;
            }
            const language = languageSelect.value;
            analyzeText(text, language);
        });

        // AI批改作文
        correctBtn.addEventListener('click', function() {
            const text = essayText.value.trim();
            if (!text) {
                alert('请先输入作文内容');
                return;
            }
            if (text.length < 50) {
                alert('作文内容过短，请输入至少50个字符的作文');
                return;
            }
            const language = languageSelect.value;
            correctEssay(text, language);
        });

        // 检测设备和浏览器类型
        function isMobileSafari() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua) && !/CriOS/.test(ua) && !/FxiOS/.test(ua);
            const isIPadOS = /Macintosh/.test(ua) && 'ontouchend' in document; // iPadOS 13+ 检测
            
            console.log('Device detection - UA:', ua);
            console.log('Device detection - isIOS:', isIOS, 'isSafari:', isSafari, 'isIPadOS:', isIPadOS);
            
            return (isIOS || isIPadOS) && isSafari;
        }
        
        // 检测是否为移动设备（包括Android）
        function isMobileDevice() {
            const ua = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            const isTablet = /iPad/.test(ua) || (/Macintosh/.test(ua) && 'ontouchend' in document);
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            return isMobile || isTablet || hasTouch;
        }

        // 检测是否支持流式处理
        function supportsStreamProcessing() {
            const hasReadableStream = 'ReadableStream' in window;
            const hasTextDecoder = 'TextDecoder' in window;
            const hasAsyncIterator = 'Symbol' in window && 'asyncIterator' in Symbol;
            const hasFetch = 'fetch' in window;
            
            // 检测是否为可能有流式问题的浏览器/设备
            const ua = navigator.userAgent;
            const isOldBrowser = /MSIE|Trident|Edge\/12|Edge\/13|Edge\/14|Edge\/15|Edge\/16/.test(ua);
            const isProblematicMobile = isMobileSafari() && /OS 12_|OS 13_/.test(ua); // 老版本iOS Safari
            
            console.log('Stream support - ReadableStream:', hasReadableStream, 'TextDecoder:', hasTextDecoder, 'AsyncIterator:', hasAsyncIterator);
            console.log('Stream support - hasFetch:', hasFetch, 'isOldBrowser:', isOldBrowser, 'isProblematicMobile:', isProblematicMobile);
            
            return hasReadableStream && hasTextDecoder && hasFetch && !isOldBrowser && !isProblematicMobile;
        }

        // 安全的JSON解析函数
        function safeJSONParse(jsonStr) {
            try {
                // 先进行基本的JSON格式检查
                if (!jsonStr || typeof jsonStr !== 'string') {
                    return null;
                }
                
                // 清理可能的非JSON字符
                const cleanStr = jsonStr.trim();
                if (!cleanStr.startsWith('{') || !cleanStr.endsWith('}')) {
                    return null;
                }
                
                // 检查括号平衡
                const openBraces = (cleanStr.match(/\{/g) || []).length;
                const closeBraces = (cleanStr.match(/\}/g) || []).length;
                if (openBraces !== closeBraces) {
                    console.warn('Unbalanced JSON braces:', cleanStr);
                    return null;
                }
                
                return JSON.parse(cleanStr);
            } catch (e) {
                console.error('JSON parse error:', e.message, 'String:', jsonStr);
                return null;
            }
        }

        // 实时输入时自动分析（可选功能）
        let debounceTimer;
        essayText.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const text = essayText.value.trim();
                const language = languageSelect.value;
                if (text) {
                    analyzeText(text, language);
                } else {
                    showInitialMessage();
                }
            }, 500); // 500ms 延迟
        });

        function analyzeText(text, language = 'zh') {
            // 显示加载状态
            statsResults.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">正在统计...</span>
                    </div>
                    <p class="mt-2 text-muted">正在分析文本...</p>
                </div>
            `;

            // 发送请求到后端API
            fetch('/api/analyze-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    language: language
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.result);
                } else {
                    statsResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            分析失败：${data.error || '未知错误'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statsResults.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        网络错误，请稍后重试
                    </div>
                `;
            });
        }

        function displayResults(result) {
            const language = languageSelect.value;

            // 根据语言调整显示内容
            let mainCountLabel, mainCountValue, summaryText;

            if (language === 'zh') {
                mainCountLabel = '汉字';
                mainCountValue = result.main_count || result.chinese_chars || 0;
                summaryText = `共检测到 <span class="badge bg-primary">${mainCountValue}</span> 个汉字`;
            } else {
                mainCountLabel = language === 'en' ? 'Words' : 'Palabras';
                mainCountValue = result.main_count || result.english_words || 0;
                const wordText = language === 'en' ? 'words' : 'palabras';
                summaryText = `共检测到 <span class="badge bg-primary">${mainCountValue}</span> 个${wordText}`;
            }

            statsResults.innerHTML = `
                <div class="row g-3">
                    <div class="col-6">
                        <div class="card bg-primary text-white h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-font fa-2x mb-2"></i>
                                <h4 class="mb-1">${mainCountValue}</h4>
                                <small>${mainCountLabel}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-warning text-white h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-quote-right fa-2x mb-2"></i>
                                <h4 class="mb-1">${result.punctuation}</h4>
                                <small>标点符号</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-info text-white h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-list-ol fa-2x mb-2"></i>
                                <h4 class="mb-1">${result.total_chars}</h4>
                                <small>总字符</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-success text-white h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-globe fa-2x mb-2"></i>
                                <h4 class="mb-1">${result.language === 'zh' ? '中文' : result.language === 'en' ? 'EN' : 'ES'}</h4>
                                <small>语言</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-light">
                        <strong>分析完成！</strong> ${summaryText}
                    </div>
                </div>
            `;
        }

        function showInitialMessage() {
            statsResults.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    请输入文本后点击"统计字数"
                </div>
            `;
        }

        function showInitialCorrectionMessage() {
            correctionResults.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    请输入作文后点击"AI批改"
                </div>
            `;
        }

        function showAiThinkingPanel() {
            aiThinkingPanel.style.display = 'block';
            // 确保面板是展开的
            const collapseElement = document.getElementById('aiThinkingContent');
            if (!collapseElement.classList.contains('show')) {
                const bsCollapse = new bootstrap.Collapse(collapseElement, { show: true });
            }
        }

        function hideAiThinkingPanel() {
            aiThinkingPanel.style.display = 'none';
        }

        function clearAiThinkingOutput() {
            aiThinkingOutput.innerHTML = '<div class="text-muted">等待AI开始批改...</div>';
            // 移除所有current-line类
            const currentLines = aiThinkingOutput.querySelectorAll('.current-line');
            currentLines.forEach(line => line.classList.remove('current-line'));
        }

        function appendToAiThinking(content) {
            // 移除初始提示
            if (aiThinkingOutput.querySelector('.text-muted')) {
                aiThinkingOutput.innerHTML = '';
            }
            
            // 获取或创建当前行元素
            let currentLine = aiThinkingOutput.querySelector('.current-line');
            if (!currentLine) {
                currentLine = document.createElement('div');
                currentLine.className = 'mb-1 current-line';
                aiThinkingOutput.appendChild(currentLine);
            }
            
            // 处理内容
            const lines = content.split('\n');
            
            // 处理第一行（追加到当前行）
            if (lines.length > 0) {
                const firstLine = lines[0];
                currentLine.textContent += firstLine;
                
                // 为特殊内容添加样式
                if (firstLine.includes('📋 开始分析：')) {
                    currentLine.className = 'mb-1 text-primary fw-bold';
                } else if (firstLine.includes('完成') || firstLine.includes('成功')) {
                    currentLine.className = 'mb-1 text-success';
                } else if (firstLine.includes('错误') || firstLine.includes('失败')) {
                    currentLine.className = 'mb-1 text-danger';
                } else if (firstLine.includes('##')) {
                    currentLine.className = 'mb-1 text-info fw-bold';
                }
            }
            
            // 处理后续行（如果有换行符）
            for (let i = 1; i < lines.length; i++) {
                // 完成当前行
                currentLine.classList.remove('current-line');
                
                // 创建新行
                const newLine = document.createElement('div');
                newLine.className = 'mb-1 current-line';
                newLine.textContent = lines[i];
                
                // 为特殊内容添加样式
                if (lines[i].includes('📋 开始分析：')) {
                    newLine.className = 'mb-1 text-primary fw-bold current-line';
                } else if (lines[i].includes('完成') || lines[i].includes('成功')) {
                    newLine.className = 'mb-1 text-success current-line';
                } else if (lines[i].includes('错误') || lines[i].includes('失败')) {
                    newLine.className = 'mb-1 text-danger current-line';
                } else if (lines[i].includes('##')) {
                    newLine.className = 'mb-1 text-info fw-bold current-line';
                }
                
                aiThinkingOutput.appendChild(newLine);
                currentLine = newLine;
            }
            
            // 平滑滚动到底部
            aiThinkingOutput.scrollTo({
                top: aiThinkingOutput.scrollHeight,
                behavior: 'smooth'
            });
            
            // 如果内容太多，保持最新的100行
            while (aiThinkingOutput.children.length > 100) {
                aiThinkingOutput.removeChild(aiThinkingOutput.firstChild);
            }
        }

        // 添加打字机效果的实时输出
        function appendToAiThinkingWithTyping(content) {
            const lines = content.split('\n');
            let currentLineIndex = 0;
            
            function typeLine() {
                if (currentLineIndex >= lines.length) return;
                
                const line = lines[currentLineIndex];
                const lineElement = document.createElement('div');
                lineElement.className = 'mb-1 fade-in';
                lineElement.textContent = '';
                
                // 区分不同类型的消息
                if (line.includes('正在分析') || line.includes('开始')) {
                    lineElement.className += ' text-primary';
                } else if (line.includes('完成') || line.includes('成功')) {
                    lineElement.className += ' text-success';
                } else if (line.includes('错误') || line.includes('失败')) {
                    lineElement.className += ' text-danger';
                } else if (line.includes('思考') || line.includes('处理')) {
                    lineElement.className += ' text-info';
                }
                
                aiThinkingOutput.appendChild(lineElement);
                
                // 打字机效果
                let charIndex = 0;
                const typingInterval = setInterval(() => {
                    if (charIndex < line.length) {
                        lineElement.textContent += line[charIndex];
                        charIndex++;
                    } else {
                        clearInterval(typingInterval);
                        currentLineIndex++;
                        setTimeout(typeLine, 100); // 短暂停顿后继续下一行
                    }
                }, 50); // 50ms per character
                
                // 滚动到底部
                aiThinkingOutput.scrollTo({
                    top: aiThinkingOutput.scrollHeight,
                    behavior: 'smooth'
                });
            }
            
            // 移除初始提示
            if (aiThinkingOutput.querySelector('.text-muted')) {
                aiThinkingOutput.innerHTML = '';
            }
            
            typeLine();
        }

        function correctEssay(text, language = 'zh') {
            // 检查网络状态
            if (!checkNetworkStatus()) {
                correctionResults.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-wifi me-2"></i>
                        网络连接不可用，请检查网络设置
                    </div>
                `;
                return;
            }
            
            // 获取选择器的值
            const wordCount = wordCountSelect.value;
            const grade = gradeSelect.value;
            
            // 显示加载状态
            correctionResults.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">正在批改...</span>
                    </div>
                    <p class="mt-2 text-muted">AI正在批改作文，请稍候...</p>
                    <small class="text-muted">这可能需要10-30秒时间</small>
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fas fa-info-circle me-1"></i>
                            年级：${grade} | 字数：${wordCount}
                        </small>
                    </div>
                </div>
            `;

            // 显示AI思考面板
            showAiThinkingPanel();
            clearAiThinkingOutput();
            aiThinkingTitle.textContent = 'AI正在思考...';

            // 智能选择处理模式：优先尝试流式，但为移动设备提供更好的降级策略
            const preferFallback = !supportsStreamProcessing() || (isMobileDevice() && navigator.connection && navigator.connection.effectiveType && navigator.connection.effectiveType.includes('2g'));
            const forceStream = localStorage.getItem('forceStreamMode') === 'true'; // 允许用户强制启用流式模式
            
            console.log('Device check - preferFallback:', preferFallback, 'forceStream:', forceStream);
            
            if (preferFallback && !forceStream) {
                console.log('Using fallback for better mobile experience');
                appendToAiThinking('检测到较慢的网络或移动设备，使用稳定批改模式...\n');
                setTimeout(() => {
                    fallbackCorrectEssay(text, language);
                }, 100);
                return;
            }

            // 使用fetch流式输出，增加错误处理和兼容性
            let streamFinished = false;
            let dataBuffer = ''; // 数据缓冲区，处理不完整的数据
            let timeoutId = null; // 超时处理
            
            // 动态超时设置：移动设备使用更长超时时间
            const timeoutDuration = isMobileDevice() ? 180000 : 120000; // 移动设备3分钟，桌面设备2分钟
            
            timeoutId = setTimeout(() => {
                if (!streamFinished) {
                    console.log(`Stream timeout after ${timeoutDuration/1000}s, falling back to regular request`);
                    streamFinished = true;
                    appendToAiThinking('\n⏰ 流式处理超时，正在切换到稳定模式...\n');
                    // 给用户更友好的提示
                    appendToAiThinking('💡 提示：如果经常超时，可以刷新页面后尝试直接使用稳定模式\n');
                    fallbackCorrectEssay(text, language);
                }
            }, timeoutDuration);
            
            fetch('/api/correct-essay-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    word_count: wordCount,
                    grade: grade,
                    language: language
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                // 添加心跳检测
                let lastActivityTime = Date.now();
                const heartbeatInterval = setInterval(() => {
                    if (streamFinished) {
                        clearInterval(heartbeatInterval);
                        return;
                    }
                    
                    const timeSinceLastActivity = Date.now() - lastActivityTime;
                    if (timeSinceLastActivity > 45000) { // 45秒无活动
                        appendToAiThinking('⏳ 正在等待AI响应，请耐心等待...\n');
                        lastActivityTime = Date.now(); // 重置计时器
                    }
                }, 30000); // 每30秒检查一次
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done || streamFinished) {
                            clearInterval(heartbeatInterval);
                            // 处理剩余缓冲区数据
                            if (dataBuffer.trim()) {
                                processBufferedData(dataBuffer);
                            }
                            return;
                        }
                        
                        lastActivityTime = Date.now(); // 更新活动时间
                        
                        const chunk = decoder.decode(value, { stream: true });
                        dataBuffer += chunk;
                        
                        // 处理完整的行
                        const lines = dataBuffer.split('\n');
                        dataBuffer = lines.pop() || ''; // 保留最后一行（可能不完整）
                        
                        lines.forEach(line => {
                            if (line.trim() && line.startsWith('data: ')) {
                                const jsonStr = line.substring(6).trim();
                                if (jsonStr) {
                                    const data = safeJSONParse(jsonStr);
                                    
                                    if (data) {
                                        if (data.type === 'thinking') {
                                            // 显示AI思考过程
                                            appendToAiThinking(data.content);
                                        } else if (data.type === 'result') {
                                            // 显示最终结果
                                            streamFinished = true;
                                            if (timeoutId) {
                                                clearTimeout(timeoutId);
                                                timeoutId = null;
                                            }
                                            aiThinkingTitle.textContent = 'AI批改完成';
                                            displayCorrectionResults(data.corrections);
                                            // 关闭读取器
                                            reader.cancel();
                                            return;
                                        } else if (data.type === 'error') {
                                            // 显示错误
                                            streamFinished = true;
                                            if (timeoutId) {
                                                clearTimeout(timeoutId);
                                                timeoutId = null;
                                            }
                                            aiThinkingTitle.textContent = 'AI批改失败';
                                            correctionResults.innerHTML = `
                                                <div class="alert alert-danger">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    批改失败：${data.error || '未知错误'}
                                                </div>
                                            `;
                                            reader.cancel();
                                            return;
                                        }
                                    } else {
                                        // 无效的JSON数据，记录但不中断流程
                                        console.warn('Invalid JSON data received:', line);
                                    }
                                }
                            }
                        });
                        
                        // 继续读取下一个chunk（如果流没有结束）
                        if (!streamFinished) {
                            return readStream();
                        }
                    }).catch(error => {
                        console.error('Stream read error:', error);
                        clearInterval(heartbeatInterval);
                        if (!streamFinished) {
                            streamFinished = true;
                            if (timeoutId) {
                                clearTimeout(timeoutId);
                                timeoutId = null;
                            }
                            
                            // 根据错误类型提供不同的处理
                            if (error.name === 'AbortError' || error.message.includes('aborted')) {
                                appendToAiThinking('\n⚠️ 连接被中断，正在尝试稳定模式...\n');
                            } else if (error.message.includes('network') || error.message.includes('fetch')) {
                                appendToAiThinking('\n🌐 网络问题，正在尝试重新连接...\n');
                            } else {
                                appendToAiThinking('\n⚠️ 流式传输遇到问题，正在切换到稳定模式...\n');
                            }
                            
                            fallbackCorrectEssay(text, language);
                        }
                    });
                }
                
                // 处理缓冲区中剩余的数据
                function processBufferedData(buffer) {
                    console.log('Processing buffered data:', buffer);
                    const lines = buffer.split('\n');
                    lines.forEach(line => {
                        if (line.trim() && line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (jsonStr) {
                                const data = safeJSONParse(jsonStr);
                                if (data && data.type === 'result') {
                                    if (timeoutId) {
                                        clearTimeout(timeoutId);
                                        timeoutId = null;
                                    }
                                    streamFinished = true;
                                    aiThinkingTitle.textContent = 'AI批改完成';
                                    displayCorrectionResults(data.corrections);
                                } else if (data && data.type === 'thinking') {
                                    // 处理思考过程数据
                                    appendToAiThinking(data.content);
                                } else {
                                    console.warn('Invalid buffered JSON data:', line);
                                }
                            }
                        }
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                console.error('Stream error:', error);
                if (!streamFinished) {
                    streamFinished = true;
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                        timeoutId = null;
                    }
                    aiThinkingTitle.textContent = 'AI批改失败';
                    // 如果流式输出失败，尝试普通请求
                    fallbackCorrectEssay(text, language);
                }
            });
        }

        function fallbackCorrectEssay(text, language = 'zh') {
            console.log('fallbackCorrectEssay called');
            
            // 获取选择器的值
            const wordCount = wordCountSelect.value;
            const grade = gradeSelect.value;
            
            // 模拟AI思考过程，提供更好的用户体验
            appendToAiThinking('🔄 正在连接AI服务（稳定模式）...\n');
            
            const feedbackSteps = [
                { delay: 500, message: '📋 正在分析作文内容...' },
                { delay: 1500, message: '🤖 AI正在细致检查语法和拼写...' },
                { delay: 3000, message: '🔍 正在分析文章结构和逻辑...' },
                { delay: 5000, message: '✍️ 正在生成详细的修改建议...' }
            ];
            
            feedbackSteps.forEach(step => {
                setTimeout(() => {
                    if (!aiThinkingOutput.textContent.includes('✅') && !aiThinkingOutput.textContent.includes('❌')) {
                        appendToAiThinking(step.message + '\n');
                    }
                }, step.delay);
            });
            
            // 增加重试机制的普通请求
            const maxRetries = 2;
            let retryCount = 0;
            
            function attemptFallbackRequest() {
                return fetch('/api/correct-essay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        word_count: wordCount,
                        grade: grade,
                        language: language
                    }),
                    timeout: 120000 // 2分钟超时
                })
                .catch(error => {
                    console.error(`Attempt ${retryCount + 1} failed:`, error);
                    retryCount++;
                    
                    if (retryCount < maxRetries) {
                        appendToAiThinking(`\n⚠️ 第${retryCount}次请求失败，正在重试...\n`);
                        return new Promise(resolve => {
                            setTimeout(() => resolve(attemptFallbackRequest()), 2000 * retryCount); // 递增延迟
                        });
                    } else {
                        throw error;
                    }
                });
            }
            
            attemptFallbackRequest()
            .then(response => {
                console.log('Fallback response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Fallback response data:', data);
                
                if (data.success) {
                    appendToAiThinking('✅ AI分析完成，正在整理批改结果...\n');
                    
                    // 确保在下一个事件循环中执行，让思考过程显示完成
                    setTimeout(() => {
                        aiThinkingTitle.textContent = 'AI批改完成';
                        
                        // 强制确保correctionResults存在
                        if (!correctionResults) {
                            console.error('correctionResults element not found in DOM');
                            return;
                        }
                        
                        console.log('About to call displayCorrectionResults with:', data.corrections);
                        displayCorrectionResults(data.corrections);
                        
                        // 显示AI原始响应（仅在开发模式下）
                        if (data.raw_response && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
                            appendToAiThinking('\n--- AI原始响应 ---\n' + data.raw_response);
                        }
                    }, 500);
                } else {
                    aiThinkingTitle.textContent = 'AI批改失败';
                    appendToAiThinking('❌ 批改失败：' + (data.error || '未知错误') + '\n');
                    correctionResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            批改失败：${data.error || '未知错误'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('All fallback attempts failed:', error);
                aiThinkingTitle.textContent = 'AI批改失败';
                
                // 根据错误类型提供更具体的建议
                let errorMessage = '网络错误，请检查网络连接后重试';
                let suggestions = [];
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = '无法连接到服务器';
                    suggestions = ['检查网络连接是否正常', '尝试刷新页面', '稍后再试'];
                } else if (error.message.includes('timeout')) {
                    errorMessage = '请求超时';
                    suggestions = ['网络较慢，请缩短作文长度', '尝试在网络状态良好时重试', '刷新页面重新开始'];
                } else if (error.message.includes('500')) {
                    errorMessage = '服务器内部错误';
                    suggestions = ['服务器正在处理大量请求，请稍后再试', '尝试刷新页面'];
                }
                
                appendToAiThinking(`\n❌ 批改失败：${errorMessage}\n`);
                
                const suggestionsHtml = suggestions.length > 0 ? 
                    `<div class="mt-2"><small class="text-muted">
                        建议：<br>
                        ${suggestions.map((s, i) => `${i + 1}. ${s}`).join('<br>')}
                    </small></div>` : '';
                
                correctionResults.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>批改失败</strong><br>
                        ${errorMessage}
                        ${suggestionsHtml}
                        <div class="mt-3">
                            <button class="btn btn-outline-danger btn-sm" onclick="correctEssay(essayText.value.trim())">
                                <i class="fas fa-redo me-1"></i>重试
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="localStorage.setItem('forceStreamMode', 'true'); correctEssay(essayText.value.trim())">
                                <i class="fas fa-stream me-1"></i>强制使用流式模式
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        // 添加网络状态检测
        function checkNetworkStatus() {
            if ('navigator' in window && 'onLine' in navigator) {
                if (!navigator.onLine) {
                    appendToAiThinking('\n⚠️ 检测到网络断开，请检查网络连接\n');
                    return false;
                }
            }
            
            if ('navigator' in window && 'connection' in navigator) {
                const connection = navigator.connection;
                if (connection && connection.effectiveType) {
                    if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                        appendToAiThinking('\n🐌 检测到网络较慢，可能需要更长时间...\n');
                    }
                }
            }
            
            return true;
        }

        function displayCorrectionResults(corrections) {
            console.log('displayCorrectionResults called with:', corrections);
            console.log('correctionResults element:', correctionResults);
            
            // 移除当前行的光标效果
            const currentLines = aiThinkingOutput.querySelectorAll('.current-line');
            currentLines.forEach(line => line.classList.remove('current-line'));
            
            // 强制确保correctionResults元素存在
            if (!correctionResults) {
                console.error('correctionResults element not found in DOM');
                // 尝试重新获取元素
                const element = document.getElementById('correctionResults');
                if (element) {
                    console.log('Found correctionResults by getElementById');
                    // 更新全局变量
                    window.correctionResults = element;
                } else {
                    console.error('correctionResults element still not found');
                    alert('界面错误：找不到批改结果显示区域，请刷新页面重试');
                    return;
                }
            }
            
            // 添加加载提示，确保用户知道结果正在显示
            correctionResults.innerHTML = `
                <div class="text-center p-3">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">正在显示结果...</span>
                    </div>
                    <p class="mt-2 text-muted">正在整理批改结果...</p>
                </div>
            `;
            
            // 延迟显示结果，确保UI有时间更新
            setTimeout(() => {
                if (!corrections || corrections.length === 0) {
                    correctionResults.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>恭喜！</strong>您的作文暂未发现明显问题。
                        </div>
                    `;
                    return;
                }
                
                displayActualResults(corrections);
            }, 300);
        }

        function displayActualResults(corrections) {

            let html = '<div class="accordion" id="correctionAccordion">';
            
            corrections.forEach((section, index) => {
                if (!section || !section.type || !section.items) {
                    console.warn('Invalid section:', section);
                    return;
                }
                
                const sectionId = `section${index}`;
                const iconMap = {
                    '总体评价': 'fas fa-star text-success',
                    '病句修改': 'fas fa-exclamation-triangle text-warning',
                    '错别字修改': 'fas fa-spell-check text-danger',
                    '标点符号修改': 'fas fa-quote-right text-info',
                    '语言表达改进建议': 'fas fa-lightbulb text-primary',
                    '内容结构改进建议': 'fas fa-list-alt text-secondary'
                };
                
                const icon = iconMap[section.type] || 'fas fa-edit';
                const isFirst = index === 0;
                
                html += `
                    <div class="accordion-item">
                        <h6 class="accordion-header" id="heading${sectionId}">
                            <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapse${sectionId}" 
                                    aria-expanded="${isFirst}" aria-controls="collapse${sectionId}">
                                <i class="${icon} me-2"></i>
                                ${section.type} (${section.items.length}项)
                            </button>
                        </h6>
                        <div id="collapse${sectionId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" 
                             aria-labelledby="heading${sectionId}" data-bs-parent="#correctionAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled mb-0">
                `;
                
                section.items.forEach((item, itemIndex) => {
                    if (typeof item === 'string') {
                        html += `<li class="mb-2"><i class="fas fa-angle-right me-2 text-muted"></i>${item}</li>`;
                    } else {
                        console.warn('Invalid item at index', itemIndex, ':', item);
                    }
                });
                
                html += `
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // 添加总结信息
            const totalIssues = corrections.reduce((sum, section) => {
                return sum + (section.items ? section.items.length : 0);
            }, 0);
            
            html = `
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>批改完成！</strong> 发现 <span class="badge bg-warning text-dark">${totalIssues}</span> 处需要改进的地方。
                </div>
            ` + html;
            
            // 设置结果内容
            correctionResults.innerHTML = html;
            
            // 强制刷新显示（特别针对iPad Safari）
            if (isMobileSafari()) {
                // 强制重新渲染
                correctionResults.style.display = 'none';
                setTimeout(() => {
                    correctionResults.style.display = 'block';
                    
                    // 滚动到结果区域
                    correctionResults.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 50);
            }
            
            // 添加完成提示到AI思考输出
            appendToAiThinking(`\n✅ 批改结果已显示，共发现 ${totalIssues} 处需要改进的地方。\n`);
            
            console.log('Correction results displayed successfully');
            
            // 设置一个验证机制，确保结果确实显示了
            setTimeout(() => {
                const resultContent = correctionResults.querySelector('.accordion');
                if (!resultContent) {
                    console.warn('Results may not have displayed properly, attempting recovery');
                    // 再次尝试显示
                    correctionResults.innerHTML = html;
                }
            }, 1000);
        }
    </script>
</body>
</html> 