<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>English Reader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container py-5">
        <h1 class="mb-4">English Reader</h1>
        <form class="mb-4 row g-3 align-items-end">
            <div class="col-md-4">
                <label for="bookSelect" class="form-label">选择教材：</label>
                <select class="form-select" id="bookSelect"></select>
            </div>
            <div class="col-md-4">
                <label for="discSelect" class="form-label">选择光盘：</label>
                <select class="form-select" id="discSelect"></select>
            </div>
            <div class="col-md-4">
                <label for="audioSelect" class="form-label">选择音频文件：</label>
                <select class="form-select" id="audioSelect"></select>
            </div>
        </form>
        <div class="card p-4 shadow-sm">
            <!-- 字幕显示区域 -->
            <div id="subtitleArea" class="mb-4" style="min-height: 4em; font-size: 1.25em; text-align: center;">
                <div id="subtitlePrev" style="color: #888; min-height: 1.5em;"></div>
                <div id="subtitleCurrent" style="font-weight: bold; min-height: 1.5em; font-size: 1.2em;"></div>
                <div id="subtitleNext" style="color: #888; min-height: 1.5em;"></div>
                <div id="subtitleStatus" class="mt-3" style="display: none;">
                    <button id="generateSubtitleBtn" class="btn btn-primary btn-sm">生成字幕</button>
                    <span id="subtitleMessage" class="text-muted ms-2"></span>
                </div>
            </div>
            <audio id="audioPlayer" class="w-100 mb-3" controls preload="none">
                <source id="audioSource" src="" type="audio/mpeg">
                您的浏览器不支持 audio 元素。
            </audio>
            <div class="d-flex justify-content-center flex-wrap gap-3">
                <button class="btn btn-outline-secondary" id="prevBtn" title="上一首"><i class="fa fa-backward-step"></i></button>
                <button class="btn btn-outline-secondary" id="rewindBtn" title="后退3秒"><i class="fa fa-backward"></i></button>
                <button class="btn btn-outline-secondary" id="playPauseBtn" title="播放/暂停"><i class="fa fa-play"></i></button>
                <button class="btn btn-outline-secondary" id="forwardBtn" title="前进3秒"><i class="fa fa-forward"></i></button>
                <button class="btn btn-outline-secondary" id="nextBtn" title="下一首"><i class="fa fa-forward-step"></i></button>
                <button class="btn btn-outline-secondary" id="slowerBtn" title="减速"><i class="fa fa-minus"></i></button>
                <button class="btn btn-outline-secondary" id="fasterBtn" title="加速"><i class="fa fa-plus"></i></button>
            </div>
            <div class="text-center mt-3">
                <span id="speedDisplay">速度：1x</span>
            </div>
        </div>
    </div>
    <script>
        const audioTree = {{ audio_tree|tojson|safe }};
        const bookSelect = document.getElementById('bookSelect');
        const discSelect = document.getElementById('discSelect');
        const audioSelect = document.getElementById('audioSelect');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioSource = document.getElementById('audioSource');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const rewindBtn = document.getElementById('rewindBtn');
        const forwardBtn = document.getElementById('forwardBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const slowerBtn = document.getElementById('slowerBtn');
        const fasterBtn = document.getElementById('fasterBtn');
        let currentBook = null;
        let currentDisc = null;
        let currentIndex = 0;
        let audioFiles = [];

        // 支持的播放速度列表
        const speedSteps = [0.5, 0.75, 1, 1.25, 1.5, 2, 3];
        let speedIndex = 2; // 1x
        const speedDisplay = document.getElementById('speedDisplay');
        function updateSpeedDisplay() {
            speedDisplay.textContent = `速度：${speedSteps[speedIndex]}x`;
        }

        function updateBookOptions() {
            bookSelect.innerHTML = '';
            Object.keys(audioTree).forEach((book, i) => {
                const opt = document.createElement('option');
                opt.value = book;
                opt.textContent = book;
                bookSelect.appendChild(opt);
            });
            currentBook = bookSelect.value;
        }

        function updateDiscOptions() {
            discSelect.innerHTML = '';
            if (!currentBook) return;
            Object.keys(audioTree[currentBook]).forEach((disc, i) => {
                const opt = document.createElement('option');
                opt.value = disc;
                opt.textContent = disc;
                discSelect.appendChild(opt);
            });
            currentDisc = discSelect.value;
        }

        function updateAudioOptions() {
            audioSelect.innerHTML = '';
            if (!currentBook || !currentDisc) return;
            audioFiles = audioTree[currentBook][currentDisc] || [];
            audioFiles.forEach((file, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = file;
                audioSelect.appendChild(opt);
            });
            currentIndex = 0;
        }

        function getAudioUrl(index) {
            const file = audioFiles[index];
            if (!file) return '';
            return `/audio/${encodeURIComponent(currentBook)}/${encodeURIComponent(currentDisc)}/${encodeURIComponent(file)}`;
        }

        // 字幕相关变量
        let subtitles = [];
        let currentSubtitleIndex = 0;
        const subtitlePrev = document.getElementById('subtitlePrev');
        const subtitleCurrent = document.getElementById('subtitleCurrent');
        const subtitleNext = document.getElementById('subtitleNext');
        // 解析 SRT 字幕
        function parseSRT(srtText) {
            const srtRegex = /\d+\s+([\d:,]+)\s+-->\s+([\d:,]+)\s+([\s\S]*?)(?=\n\d+\s|$)/g;
            const toSeconds = t => {
                const [h, m, s] = t.replace(',', ':').split(':');
                return parseInt(h)*3600 + parseInt(m)*60 + parseFloat(s);
            };
            let result = [];
            let match;
            while ((match = srtRegex.exec(srtText)) !== null) {
                result.push({
                    start: toSeconds(match[1]),
                    end: toSeconds(match[2]),
                    text: match[3].replace(/\n/g, ' ').trim()
                });
            }
            return result;
        }
        // 加载字幕文件
        async function loadSubtitle(book, disc, file) {
            if (!book || !disc || !file) return;

            // replace mp3 to srt
            file_name = file.replace('.mp3', '.srt');
            const subtitleUrl = `/subtitles/${encodeURIComponent(book)}/${encodeURIComponent(disc)}/${encodeURIComponent(file_name)}`;
            try {
                const resp = await fetch(subtitleUrl);
                if (!resp.ok) {
                    throw new Error('字幕文件未找到');
                }
                const srtText = await resp.text();
                subtitles = parseSRT(srtText);
                subtitleStatus.style.display = 'none';
            } catch (e) {
                subtitles = [];
                subtitleStatus.style.display = 'block';
                subtitleMessage.textContent = '没有找到字幕文件';
            }
            currentSubtitleIndex = 0;
            updateSubtitleDisplay(0);
        }
        // 更新字幕显示
        function updateSubtitleDisplay(currentTime) {
            if (!subtitles.length) {
                subtitlePrev.textContent = '';
                subtitleCurrent.textContent = '';
                subtitleNext.textContent = '';
                return;
            }
            
            // 找到当前字幕索引 - 改进查找逻辑，避免跳跃
            let idx = -1;
            
            // 先尝试从当前索引附近查找，避免大范围跳跃
            const nearRange = 3; // 搜索范围
            const startIdx = Math.max(0, currentSubtitleIndex - nearRange);
            const endIdx = Math.min(subtitles.length - 1, currentSubtitleIndex + nearRange);
            
            for (let i = startIdx; i <= endIdx; i++) {
                if (currentTime >= subtitles[i].start && currentTime < subtitles[i].end) {
                    idx = i;
                    break;
                }
            }
            
            // 如果在附近没找到，再全局搜索
            if (idx === -1) {
                for (let i = 0; i < subtitles.length; i++) {
                    if (currentTime >= subtitles[i].start && currentTime < subtitles[i].end) {
                        idx = i;
                        break;
                    }
                }
            }
            
            // 如果仍然没找到匹配的字幕，找到最接近的一个
            if (idx === -1) {
                let minDiff = Number.MAX_VALUE;
                for (let i = 0; i < subtitles.length; i++) {
                    // 计算当前时间与字幕中间点的差距
                    const midTime = (subtitles[i].start + subtitles[i].end) / 2;
                    const diff = Math.abs(currentTime - midTime);
                    if (diff < minDiff) {
                        minDiff = diff;
                        idx = i;
                    }
                }
            }
            
            // 如果索引发生改变，更新显示
            if (idx !== currentSubtitleIndex) {
                currentSubtitleIndex = idx;
                subtitlePrev.textContent = subtitles[idx - 1]?.text || '';
                subtitleCurrent.textContent = subtitles[idx]?.text || '';
                subtitleNext.textContent = subtitles[idx + 1]?.text || '';
            }
        }
        // 监听音频播放进度
        audioPlayer.addEventListener('timeupdate', function() {
            updateSubtitleDisplay(audioPlayer.currentTime);
        });
        // 切换音频时加载字幕
        function loadAudio(index) {
            if (!audioFiles.length) return;
            audioSource.src = getAudioUrl(index);
            audioPlayer.load();
            currentIndex = index;
            audioSelect.selectedIndex = index;
            // 切歌时重置播放速度为 1x
            speedIndex = 2;
            audioPlayer.playbackRate = speedSteps[speedIndex];
            updateSpeedDisplay();
            // 加载字幕
            loadSubtitle(currentBook, currentDisc, audioFiles[index]);
        }

        // 字幕生成相关
        const subtitleStatus = document.getElementById('subtitleStatus');
        const generateSubtitleBtn = document.getElementById('generateSubtitleBtn');
        const subtitleMessage = document.getElementById('subtitleMessage');

        // 生成字幕
        generateSubtitleBtn.addEventListener('click', async function() {
            if (!currentBook || !currentDisc || !audioFiles[currentIndex]) return;
            
            const fileName = audioFiles[currentIndex];
            subtitleMessage.textContent = '字幕生成中，请稍候...';
            generateSubtitleBtn.disabled = true;
            
            try {
                const response = await fetch('/generate-subtitle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        book: currentBook,
                        disc: currentDisc,
                        filename: fileName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    subtitleMessage.textContent = '字幕生成成功，正在加载...';
                    // 重新加载字幕
                    await loadSubtitle(currentBook, currentDisc, fileName);
                    subtitleStatus.style.display = 'none';
                } else {
                    throw new Error(data.error || '字幕生成失败');
                }
            } catch (error) {
                subtitleMessage.textContent = `错误: ${error.message}`;
            } finally {
                generateSubtitleBtn.disabled = false;
            }
        });

        bookSelect.addEventListener('change', function() {
            currentBook = this.value;
            updateDiscOptions();
            updateAudioOptions();
            loadAudio(0);
        });
        discSelect.addEventListener('change', function() {
            currentDisc = this.value;
            updateAudioOptions();
            loadAudio(0);
        });
        audioSelect.addEventListener('change', function() {
            loadAudio(this.selectedIndex);
        });

        playPauseBtn.addEventListener('click', async function() {
            if (audioPlayer.paused) {
                try {
                    await audioPlayer.play();
                    this.querySelector('i').className = 'fa fa-pause';
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        console.error(e);
                    }
                }
            } else {
                audioPlayer.pause();
                this.querySelector('i').className = 'fa fa-play';
            }
        });
        audioPlayer.addEventListener('play', function() {
            playPauseBtn.querySelector('i').className = 'fa fa-pause';
        });
        audioPlayer.addEventListener('pause', function() {
            playPauseBtn.querySelector('i').className = 'fa fa-play';
        });
        rewindBtn.addEventListener('click', function() {
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 3);
        });
        forwardBtn.addEventListener('click', function() {
            audioPlayer.currentTime = Math.min(audioPlayer.duration || 0, audioPlayer.currentTime + 3);
        });
        prevBtn.addEventListener('click', function() {
            if (currentIndex > 0) {
                loadAudio(currentIndex - 1);
                audioPlayer.play();
            }
        });
        nextBtn.addEventListener('click', function() {
            if (currentIndex < audioFiles.length - 1) {
                loadAudio(currentIndex + 1);
                audioPlayer.play();
            }
        });
        slowerBtn.addEventListener('click', function() {
            if (speedIndex > 0) {
                speedIndex--;
                audioPlayer.playbackRate = speedSteps[speedIndex];
                updateSpeedDisplay();
            }
        });
        fasterBtn.addEventListener('click', function() {
            if (speedIndex < speedSteps.length - 1) {
                speedIndex++;
                audioPlayer.playbackRate = speedSteps[speedIndex];
                updateSpeedDisplay();
            }
        });

        // 初始化
        updateBookOptions();
        updateDiscOptions();
        updateAudioOptions();
        
        // 添加 Cookie 功能
        function saveLastPlayedContent() {
            const lastPlayed = {
                book: currentBook,
                disc: currentDisc,
                index: currentIndex,
                time: audioPlayer.currentTime
            };
            
            // 设置 cookie，有效期 30 天
            const expires = new Date();
            expires.setTime(expires.getTime() + 30 * 24 * 60 * 60 * 1000);
            document.cookie = `lastPlayed=${JSON.stringify(lastPlayed)};expires=${expires.toUTCString()};path=/`;
        }
        
        function getLastPlayedContent() {
            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'lastPlayed') {
                    try {
                        return JSON.parse(decodeURIComponent(value));
                    } catch (e) {
                        console.error('Failed to parse last played cookie:', e);
                        return null;
                    }
                }
            }
            return null;
        }
        
        function loadLastPlayedContent() {
            const lastPlayed = getLastPlayedContent();
            if (!lastPlayed) {
                // 没有之前的播放记录，加载第一个
                loadAudio(0);
                return;
            }
            
            // 设置选项
            if (lastPlayed.book && audioTree[lastPlayed.book]) {
                bookSelect.value = lastPlayed.book;
                currentBook = lastPlayed.book;
                
                updateDiscOptions();
                
                if (lastPlayed.disc && audioTree[lastPlayed.book][lastPlayed.disc]) {
                    discSelect.value = lastPlayed.disc;
                    currentDisc = lastPlayed.disc;
                    
                    updateAudioOptions();
                    
                    if (typeof lastPlayed.index === 'number' && audioFiles[lastPlayed.index]) {
                        // 加载音频
                        loadAudio(lastPlayed.index);
                        
                        // 设置播放位置
                        if (typeof lastPlayed.time === 'number') {
                            audioPlayer.addEventListener('canplay', function setTime() {
                                audioPlayer.currentTime = lastPlayed.time;
                                audioPlayer.removeEventListener('canplay', setTime);
                            });
                        }
                        
                        return;
                    }
                }
            }
            
            // 如果任何条件不满足，加载第一个
            loadAudio(0);
        }
        
        // 保存播放位置的事件
        audioPlayer.addEventListener('pause', saveLastPlayedContent);
        audioPlayer.addEventListener('ended', saveLastPlayedContent);
        window.addEventListener('beforeunload', saveLastPlayedContent);
        
        // 启动时加载上次播放的内容
        loadLastPlayedContent();
        updateSpeedDisplay();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 