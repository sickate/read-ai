<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>在线朗读 - 超能力训练场</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 响应式设计 */
        @media (max-width: 768px) {
            .card-body {
                padding: 1rem !important;
            }

            .btn {
                margin-bottom: 0.5rem;
            }
        }

        /* 文本输入框样式 */
        #textInput {
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
        }

        /* 音频播放器容器样式 */
        #audioPlayerContainer {
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 0.375rem;
            padding: 2rem;
            text-align: center;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #audioPlayerContainer.active {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }

        .audio-controls {
            width: 100%;
            max-width: 500px;
        }

        /* 加载动画 */
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* 字符计数器 */
        #charCount {
            font-size: 0.875rem;
            color: #6c757d;
        }

        #charCount.warning {
            color: #fd7e14;
        }

        #charCount.danger {
            color: #dc3545;
        }

        /* 提示信息 */
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    {% include '_navigation.html' %}

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- 标题 -->
                <div class="text-center mb-4">
                    <h1><i class="fas fa-volume-up text-primary"></i> 在线朗读</h1>
                    <p class="text-muted">支持中英文文本转语音，多种音色可选</p>
                </div>

                <!-- 提示信息 -->
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <strong>使用说明：</strong>输入文本，选择喜欢的音色和语言，点击"开始朗读"即可生成语音。支持中英文及多语言混合。
                </div>

                <!-- 主要内容卡片 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <form id="ttsForm">
                            <!-- 文本输入 -->
                            <div class="mb-3">
                                <label for="textInput" class="form-label">
                                    <i class="fas fa-keyboard"></i> 输入文本
                                </label>
                                <textarea
                                    class="form-control"
                                    id="textInput"
                                    rows="6"
                                    placeholder="请输入要朗读的文本，支持中文、英文及多语言混合..."
                                    maxlength="5000"
                                    required></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb"></i> 示例：Hello! 你好，这是一个文本转语音测试。
                                    </small>
                                    <span id="charCount">0 / 5000</span>
                                </div>
                            </div>

                            <!-- 参数选择 -->
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label for="voiceSelect" class="form-label">
                                        <i class="fas fa-microphone"></i> 选择音色
                                    </label>
                                    <select class="form-select" id="voiceSelect">
                                        {% for voice_id, voice_name in voices.items() %}
                                        <option value="{{ voice_id }}">{{ voice_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="languageSelect" class="form-label">
                                        <i class="fas fa-language"></i> 语言类型
                                    </label>
                                    <select class="form-select" id="languageSelect">
                                        {% for lang_code, lang_name in languages.items() %}
                                        <option value="{{ lang_code }}">{{ lang_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- 操作按钮 -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                                <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                                    <i class="fas fa-play"></i> 开始朗读
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg" id="clearBtn">
                                    <i class="fas fa-eraser"></i> 清空
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 音频播放器 -->
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-headphones"></i> 音频播放器</h5>
                    </div>
                    <div class="card-body">
                        <div id="audioPlayerContainer">
                            <div id="audioPlaceholder">
                                <i class="fas fa-music fa-3x text-muted mb-3"></i>
                                <p class="text-muted">等待生成音频...</p>
                            </div>
                            <div id="audioLoading" class="d-none">
                                <div class="spinner-border text-primary mb-3" role="status"></div>
                                <p class="text-primary">正在生成语音，请稍候...</p>
                            </div>
                            <div id="audioPlayer" class="d-none">
                                <audio id="audioElement" preload="metadata">
                                    您的浏览器不支持音频播放。
                                </audio>

                                <!-- 自定义控制器 -->
                                <div class="d-flex justify-content-center flex-wrap gap-2 mb-3">
                                    <button class="btn btn-outline-secondary" id="rewindBtn" title="后退3秒">
                                        <i class="fa fa-backward"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" id="playPauseBtn" title="播放/暂停">
                                        <i class="fa fa-play"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" id="forwardBtn" title="前进3秒">
                                        <i class="fa fa-forward"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" id="slowerBtn" title="减速">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" id="fasterBtn" title="加速">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>

                                <div class="text-center mb-2">
                                    <span id="speedDisplay" class="badge bg-primary">速度：1x</span>
                                </div>

                                <p class="text-muted small text-center mb-0">
                                    <i class="fas fa-info-circle"></i> 音频链接24小时内有效
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 使用说明 -->
                <div class="card shadow-sm mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-question-circle"></i> 功能说明</h5>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            <li><strong>多音色支持：</strong>提供12种音色选择，包括通用音色（Cherry、Ethan等）和方言音色（北京话、上海话、粤语等）</li>
                            <li><strong>多语言支持：</strong>支持中文、英文、日语、韩语等多种语言，自动检测语言类型</li>
                            <li><strong>中英混合：</strong>可以在同一段文本中混合使用中英文，系统会自然切换发音</li>
                            <li><strong>播放控制：</strong>支持播放/暂停、快进/后退3秒、7级调速（0.5x - 3x）</li>
                            <li><strong>文本限制：</strong>单次最多支持5000个字符的文本转语音</li>
                            <li><strong>音频有效期：</strong>生成的音频URL在24小时内有效，请及时下载或收听</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 字符计数
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');

        textInput.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = `${length} / 5000`;

            // 更新样式
            charCount.classList.remove('warning', 'danger');
            if (length > 4500) {
                charCount.classList.add('danger');
            } else if (length > 4000) {
                charCount.classList.add('warning');
            }
        });

        // 表单提交
        const ttsForm = document.getElementById('ttsForm');
        const generateBtn = document.getElementById('generateBtn');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');
        const audioPlaceholder = document.getElementById('audioPlaceholder');
        const audioLoading = document.getElementById('audioLoading');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioElement = document.getElementById('audioElement');

        ttsForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const text = textInput.value.trim();
            if (!text) {
                alert('请输入文本内容！');
                return;
            }

            const voice = document.getElementById('voiceSelect').value;
            const language = document.getElementById('languageSelect').value;

            // 显示加载状态
            generateBtn.disabled = true;
            audioPlaceholder.classList.add('d-none');
            audioPlayer.classList.add('d-none');
            audioLoading.classList.remove('d-none');
            audioPlayerContainer.classList.add('active');

            try {
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        voice: voice,
                        language: language
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // 设置音频源并显示播放器
                    audioElement.src = result.audio_url;
                    audioLoading.classList.add('d-none');
                    audioPlayer.classList.remove('d-none');

                    // 自动播放
                    try {
                        await audioElement.play();
                    } catch (err) {
                        console.log('自动播放失败，请手动点击播放按钮');
                    }
                } else {
                    throw new Error(result.error || '生成失败');
                }
            } catch (error) {
                alert('生成语音失败：' + error.message);
                audioLoading.classList.add('d-none');
                audioPlaceholder.classList.remove('d-none');
                audioPlayerContainer.classList.remove('active');
            } finally {
                generateBtn.disabled = false;
            }
        });

        // 播放器控制
        const playPauseBtn = document.getElementById('playPauseBtn');
        const rewindBtn = document.getElementById('rewindBtn');
        const forwardBtn = document.getElementById('forwardBtn');
        const slowerBtn = document.getElementById('slowerBtn');
        const fasterBtn = document.getElementById('fasterBtn');
        const speedDisplay = document.getElementById('speedDisplay');

        // 支持的播放速度列表
        const speedSteps = [0.5, 0.75, 1, 1.25, 1.5, 2, 3];
        let speedIndex = 2; // 默认 1x

        function updateSpeedDisplay() {
            speedDisplay.textContent = `速度：${speedSteps[speedIndex]}x`;
        }

        // 播放/暂停
        playPauseBtn.addEventListener('click', async function() {
            if (audioElement.paused) {
                try {
                    await audioElement.play();
                    this.querySelector('i').className = 'fa fa-pause';
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        console.error(e);
                    }
                }
            } else {
                audioElement.pause();
                this.querySelector('i').className = 'fa fa-play';
            }
        });

        // 监听音频播放状态
        audioElement.addEventListener('play', function() {
            playPauseBtn.querySelector('i').className = 'fa fa-pause';
        });

        audioElement.addEventListener('pause', function() {
            playPauseBtn.querySelector('i').className = 'fa fa-play';
        });

        // 后退3秒
        rewindBtn.addEventListener('click', function() {
            audioElement.currentTime = Math.max(0, audioElement.currentTime - 3);
        });

        // 前进3秒
        forwardBtn.addEventListener('click', function() {
            audioElement.currentTime = Math.min(audioElement.duration || 0, audioElement.currentTime + 3);
        });

        // 减速
        slowerBtn.addEventListener('click', function() {
            if (speedIndex > 0) {
                speedIndex--;
                audioElement.playbackRate = speedSteps[speedIndex];
                updateSpeedDisplay();
            }
        });

        // 加速
        fasterBtn.addEventListener('click', function() {
            if (speedIndex < speedSteps.length - 1) {
                speedIndex++;
                audioElement.playbackRate = speedSteps[speedIndex];
                updateSpeedDisplay();
            }
        });

        // 清空按钮
        const clearBtn = document.getElementById('clearBtn');
        clearBtn.addEventListener('click', function() {
            textInput.value = '';
            charCount.textContent = '0 / 5000';
            charCount.classList.remove('warning', 'danger');

            // 重置音频播放器
            audioElement.pause();
            audioElement.src = '';
            audioPlayer.classList.add('d-none');
            audioPlaceholder.classList.remove('d-none');
            audioPlayerContainer.classList.remove('active');

            // 重置播放速度
            speedIndex = 2;
            audioElement.playbackRate = 1;
            updateSpeedDisplay();
        });

        // 初始化速度显示
        updateSpeedDisplay();
    </script>
</body>
</html>
